# Tutorial 10-2-1: ミドルウェアとは

## 🎯 このセクションで学ぶこと

*   ミドルウェアが何であるか、その役割を理解する。
*   Laravelのリクエストライフサイクルにおけるミドルウェアの位置づけを理解する。
*   グローバルミドルウェア、ミドルウェアグループ、ルートミドルウェアの違いを理解する。

---

## 導入：リクエストとレスポンスの「間」に処理を挟む

これまでのセクションで、ルーティング、コントローラー、認証など、Laravelの様々な機能を学んできました。しかし、実際のWebアプリケーションでは、「リクエストがコントローラーに到達する前」や「レスポンスがクライアントに返される前」に、共通の処理を実行したいことがあります。

例えば、以下のような処理です。

*   **認証チェック**: ログインしていないユーザーを弾く
*   **権限チェック**: 管理者以外のアクセスを拒否する
*   **ログ記録**: 全てのリクエストをログに記録する
*   **CORS設定**: クロスオリジンリクエストを許可する
*   **メンテナンスモード**: メンテナンス中は全てのリクエストを拒否する

これらの処理を、全てのコントローラーに書くのは非効率です。そこで、Laravelでは、**ミドルウェア（Middleware）**という仕組みを使って、リクエストとレスポンスの「間」に処理を挟み込むことができます。

---

## 詳細解説

### 🔄 ミドルウェアとは？

ミドルウェアとは、**リクエストがコントローラーに到達する前、またはレスポンスがクライアントに返される前に実行される処理**です。ミドルウェアは、リクエストをフィルタリングしたり、レスポンスを加工したりすることができます。

**リクエストライフサイクルにおけるミドルウェアの位置**

```
クライアント
   ↓
【リクエスト】
   ↓
ミドルウェア1（例：CORS設定）
   ↓
ミドルウェア2（例：認証チェック）
   ↓
ミドルウェア3（例：権限チェック）
   ↓
コントローラー（ビジネスロジック）
   ↓
【レスポンス】
   ↓
ミドルウェア3（レスポンス加工）
   ↓
ミドルウェア2（レスポンス加工）
   ↓
ミドルウェア1（レスポンス加工）
   ↓
クライアント
```

ミドルウェアは、**玉ねぎの層**のように、リクエストとレスポンスを包み込みます。これを「ミドルウェアスタック」と呼びます。

---

### 🤔 なぜミドルウェアが必要なのか？

ミドルウェアがない場合、共通の処理を各コントローラーに書く必要があります。

**ミドルウェアがない場合（非効率）**

```php
class PostController extends Controller
{
    public function index()
    {
        // 認証チェック（毎回書く必要がある）
        if (!auth()->check()) {
            return redirect('/login');
        }
        
        // 本来の処理
        $posts = Post::all();
        return view('posts.index', compact('posts'));
    }
    
    public function store(Request $request)
    {
        // 認証チェック（また書く）
        if (!auth()->check()) {
            return redirect('/login');
        }
        
        // 本来の処理
        Post::create($request->all());
        return redirect('/posts');
    }
}
```

**ミドルウェアがある場合（効率的）**

```php
// routes/web.php
Route::middleware('auth')->group(function () {
    Route::get('/posts', [PostController::class, 'index']);
    Route::post('/posts', [PostController::class, 'store']);
});

// コントローラーは本来の処理だけに集中できる
class PostController extends Controller
{
    public function index()
    {
        $posts = Post::all();
        return view('posts.index', compact('posts'));
    }
    
    public function store(Request $request)
    {
        Post::create($request->all());
        return redirect('/posts');
    }
}
```

ミドルウェアを使うことで、**関心の分離**（Separation of Concerns）が実現でき、コードの保守性が向上します。

---

### 📝 Laravelの標準ミドルウェア

Laravelには、いくつかのミドルウェアが標準で用意されています。

| ミドルウェア | 説明 |
|:---|:---|
| `auth` | 認証されていないユーザーをログインページにリダイレクト |
| `auth:sanctum` | Sanctumトークンで認証されていないユーザーを拒否 |
| `guest` | 認証済みユーザーをホームページにリダイレクト |
| `throttle` | リクエストのレート制限（1分間に60回まで、など） |
| `verified` | メールアドレスが確認されていないユーザーを拒否 |

これらのミドルウェアは、`app/Http/Kernel.php`に登録されています。

---

### 🔍 ミドルウェアの実行順序

複数のミドルウェアを適用した場合、以下の順序で実行されます。

```php
Route::middleware(['first', 'second', 'third'])->group(function () {
    Route::get('/example', [ExampleController::class, 'index']);
});
```

**実行順序**

```
リクエスト
   ↓
first（リクエスト処理）
   ↓
second（リクエスト処理）
   ↓
third（リクエスト処理）
   ↓
コントローラー
   ↓
third（レスポンス処理）
   ↓
second（レスポンス処理）
   ↓
first（レスポンス処理）
   ↓
レスポンス
```

ミドルウェアは、リクエスト時は**上から下**へ、レスポンス時は**下から上**へ実行されます。

---

### 🎯 ミドルウェアの3つの適用範囲

Laravelでは、ミドルウェアを適用する範囲によって、3つの種類に分類されます。

**グローバルミドルウェア**

**全てのリクエスト**に対して自動的に実行されるミドルウェアです。アプリケーション全体で共通の処理（ログ記録、CORS設定など）に使用します。

| 特徴 | 説明 |
|:---|:---|
| 適用範囲 | 全てのHTTPリクエスト |
| 登録場所 | `app/Http/Kernel.php`の`$middleware`プロパティ |
| 使用例 | ログ記録、CORS設定、メンテナンスモードチェック |

**ミドルウェアグループ**

**複数のミドルウェアをまとめて**、特定のルートグループに適用するための仕組みです。Laravelでは、`web`と`api`という2つのグループがデフォルトで用意されています。

| グループ名 | 説明 |
|:---|:---|
| `web` | セッション、CSRF保護など、Webアプリケーション向けのミドルウェア |
| `api` | レート制限など、API向けのミドルウェア |

| 特徴 | 説明 |
|:---|:---|
| 適用範囲 | グループに属するルート |
| 登録場所 | `app/Http/Kernel.php`の`$middlewareGroups`プロパティ |
| 使用例 | Webルート用の共通処理、APIルート用の共通処理 |

**ルートミドルウェア（エイリアスミドルウェア）**

**特定のルートにのみ**適用するミドルウェアです。エイリアス（別名）を付けて、ルート定義で指定します。

| 特徴 | 説明 |
|:---|:---|
| 適用範囲 | 指定したルートのみ |
| 登録場所 | `app/Http/Kernel.php`の`$middlewareAliases`プロパティ |
| 使用例 | 認証チェック、権限チェック、年齢確認 |

---

### 📊 3つのミドルウェアの比較

| 種類 | 適用範囲 | 登録場所 | 使用例 |
|:---|:---|:---|:---|
| グローバル | 全リクエスト | `$middleware` | ログ記録、CORS |
| グループ | ルートグループ | `$middlewareGroups` | web、api |
| ルート | 特定ルート | `$middlewareAliases` | auth、admin |

---

### 🎯 レスポンスを加工するミドルウェア

ミドルウェアは、リクエストをフィルタリングするだけでなく、**レスポンスを加工する**こともできます。

**例：全てのレスポンスにカスタムヘッダーを追加する**

```php
public function handle(Request $request, Closure $next)
{
    // 次のミドルウェアまたはコントローラーを実行
    $response = $next($request);

    // レスポンスにカスタムヘッダーを追加
    $response->headers->set('X-Custom-Header', 'MyValue');

    return $response;
}
```

この例では、`$next($request)`でコントローラーの処理を実行した後、レスポンスにヘッダーを追加しています。

---

## ✨ まとめ

このセクションでは、Laravelのミドルウェアの概念と役割について学びました。

*   ミドルウェアとは、リクエストがコントローラーに到達する前、またはレスポンスがクライアントに返される前に実行される処理である。
*   ミドルウェアは、認証チェック、権限チェック、ログ記録、CORS設定などに使われる。
*   ミドルウェアには、グローバルミドルウェア、ミドルウェアグループ、ルートミドルウェアの3種類がある。
*   ミドルウェアを使うことで、関心の分離が実現でき、コードの保守性が向上する。

次のセクションでは、**カスタムミドルウェアの作成方法**と、3種類のミドルウェアの**具体的な実装方法**について学びます。

---
