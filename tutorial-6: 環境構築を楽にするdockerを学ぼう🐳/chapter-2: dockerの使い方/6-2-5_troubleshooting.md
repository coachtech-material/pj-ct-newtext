# Tutorial 6-2-5: Dockerのトラブルシューティング

## 🎯 このセクションで学ぶこと

*   Docker環境でよく発生するトラブルと、その解決方法を学ぶ。
*   問題が発生した時に、どこを確認すればよいかを理解する。
*   Docker Desktopを使った問題の切り分け方法を学ぶ。

---

## 導入

Docker環境で開発を行っていると、「コンテナが起動しない」「ブラウザでアクセスできない」「データベースに接続できない」といったトラブルに遭遇することがあります。

このセクションでは、よくあるトラブルとその解決方法を紹介します。トラブルが発生した時に、このセクションを参照してください。

---

## よくあるトラブルと解決方法

### 🔴 トラブル1: コンテナが起動しない

**症状:**
`docker-compose up -d`を実行しても、コンテナが起動しない。または、起動してもすぐに停止してしまう。

**確認方法:**

1. **Docker Desktopが起動しているか確認**
   
   タスクバー（Windows）またはメニューバー（Mac）に、Dockerのアイコン（クジラのマーク）が表示されているか確認してください。表示されていない場合は、Docker Desktopを起動してください。

2. **コンテナの状態を確認**
   
   ```bash
   docker-compose ps -a
   ```
   
   `STATUS`が`Exited`になっている場合、コンテナが停止しています。

3. **ログを確認**
   
   ```bash
   docker-compose logs
   ```
   
   エラーメッセージが表示されていないか確認してください。

**よくある原因と対処法:**

| 原因 | 対処法 |
| :--- | :--- |
| Docker Desktopが起動していない | Docker Desktopを起動する |
| `docker-compose.yml`の記述ミス | インデント（字下げ）が正しいか確認する |
| イメージのダウンロードに失敗 | インターネット接続を確認し、再度`docker-compose up -d`を実行 |

---

### 🔴 トラブル2: ポートが競合している

**症状:**
`docker-compose up -d`を実行すると、以下のようなエラーが表示される。

```
Error response from daemon: Ports are not available: listen tcp 0.0.0.0:8080: bind: address already in use
```

**原因:**
指定したポート（この例では8080）が、既に他のアプリケーションで使用されている。

**確認方法（Docker Desktop）:**

1. Docker Desktopを開く
2. **Containers**メニューをクリック
3. 同じポートを使用している他のコンテナがないか確認

**対処法:**

1. **他のコンテナを停止する**
   
   Docker Desktopで、競合しているコンテナを停止する。または、以下のコマンドで全てのコンテナを停止する。
   
   ```bash
   docker stop $(docker ps -q)
   ```

2. **別のポートを使用する**
   
   `docker-compose.yml`のポート設定を変更する。
   
   ```yaml
   ports:
     - "8081:80"  # 8080を8081に変更
   ```

3. **ポートを使用しているアプリケーションを終了する**
   
   Docker以外のアプリケーション（例: XAMPP、MAMP、他のWebサーバー）が同じポートを使用している場合は、そのアプリケーションを終了する。

---

### 🔴 トラブル3: ブラウザでアクセスできない

**症状:**
コンテナは起動しているのに、ブラウザで`http://localhost:8080`にアクセスしても、ページが表示されない。

**確認方法:**

1. **コンテナが本当に起動しているか確認**
   
   Docker Desktopの**Containers**メニューで、コンテナが**緑色のアイコン（Running）**になっているか確認。

2. **ポートの設定を確認**
   
   Docker Desktopでコンテナをクリックし、**Ports**タブで、ポートが正しく設定されているか確認。

3. **URLが正しいか確認**
   
   `http://localhost:8080`（`https`ではなく`http`）にアクセスしているか確認。

**よくある原因と対処法:**

| 原因 | 対処法 |
| :--- | :--- |
| コンテナが停止している | `docker-compose up -d`で再起動 |
| ポート番号が違う | `docker-compose.yml`のポート設定を確認 |
| `https`でアクセスしている | `http`でアクセスする |
| ファイアウォールがブロックしている | ファイアウォールの設定を確認 |

---

### 🔴 トラブル4: データベースに接続できない

**症状:**
アプリケーションからデータベースに接続しようとすると、「Connection refused」や「Access denied」といったエラーが発生する。

**確認方法:**

1. **データベースコンテナが起動しているか確認**
   
   Docker Desktopで、MySQLやPostgreSQLのコンテナが起動しているか確認。

2. **接続情報を確認**
   
   `.env`ファイルや設定ファイルの、データベース接続情報が正しいか確認。

**よくある原因と対処法:**

| 原因 | 対処法 |
| :--- | :--- |
| DBコンテナが起動していない | Docker Desktopで確認し、起動する |
| ホスト名が間違っている | Docker Compose内では、サービス名（例: `mysql`）をホスト名として使用する |
| パスワードが間違っている | `docker-compose.yml`の`environment`セクションと、アプリケーションの設定を照合する |
| DBの初期化が完了していない | コンテナ起動後、数秒〜数十秒待ってから再度接続を試みる |

---

### 🔴 トラブル5: ファイルの変更が反映されない

**症状:**
ホストOS側でファイルを編集しても、コンテナ内に反映されない。

**確認方法:**

1. **`volumes`の設定を確認**
   
   `docker-compose.yml`の`volumes`セクションで、正しいパスが指定されているか確認。

2. **パスの記述を確認**
   
   相対パス（`./src`）と絶対パス（`/Users/username/project/src`）が正しいか確認。

**よくある原因と対処法:**

| 原因 | 対処法 |
| :--- | :--- |
| `volumes`の設定が間違っている | パスを確認し、修正後に`docker-compose down`→`docker-compose up -d`で再起動 |
| キャッシュが残っている | ブラウザのキャッシュをクリア、またはシークレットモードでアクセス |

---

## 問題解決の基本ステップ

トラブルが発生した時は、以下の順序で確認していくと、問題を特定しやすくなります。

### Step 1: Docker Desktopを確認

1. Docker Desktopが起動しているか
2. コンテナが起動しているか（緑色のアイコン）
3. ポートが正しく設定されているか

### Step 2: ログを確認

```bash
docker-compose logs
```

エラーメッセージが出ていないか確認します。特定のサービスのログだけを見たい場合は、サービス名を指定します。

```bash
docker-compose logs php
docker-compose logs mysql
```

### Step 3: コンテナを再起動

多くの問題は、コンテナを再起動することで解決します。

```bash
docker-compose down
docker-compose up -d
```

### Step 4: イメージを再ビルド

設定ファイルを変更した場合は、イメージを再ビルドする必要があることがあります。

```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### Step 5: 全てをリセット

それでも解決しない場合は、コンテナ、ネットワーク、ボリュームを全て削除して、最初からやり直します。

```bash
docker-compose down -v
docker-compose up -d
```

> ⚠️ **注意**: `-v`オプションを付けると、ボリューム（データベースのデータなど）も削除されます。データが消えても問題ない場合のみ使用してください。

---

## ✨ まとめ

このセクションでは、Docker環境でよく発生するトラブルと、その解決方法について学びました。

| トラブル | 最初に確認すること |
| :--- | :--- |
| コンテナが起動しない | Docker Desktopが起動しているか、ログにエラーがないか |
| ポートが競合している | 他のコンテナやアプリケーションが同じポートを使っていないか |
| ブラウザでアクセスできない | コンテナが起動しているか、ポート番号が正しいか |
| DBに接続できない | DBコンテナが起動しているか、接続情報が正しいか |
| ファイルの変更が反映されない | `volumes`の設定が正しいか |

**問題解決の基本:**

1. Docker Desktopでコンテナの状態を確認
2. `docker-compose logs`でエラーを確認
3. `docker-compose down`→`docker-compose up -d`で再起動

トラブルが発生しても、慌てずに、一つずつ確認していきましょう。

次のセクションでは、実際に手を動かして、PHP実行環境をDocker Composeで構築してみましょう。

---
