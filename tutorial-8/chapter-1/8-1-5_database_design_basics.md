# Tutorial 8-1-5: データベース設計の基礎（正規化とER図）

## 🎯 このセクションで学ぶこと

*   正規化が、「データの、重複をなくし、効率的な、データ管理を、目指すための、手順」であることを、理解する。
*   第1正規形から、第3正規形までの、基本的な、考え方を、説明できるようになる。
*   ER図（エンティティ・リレーションシップ図）が、「データベースの、設計図」であり、テーブル間の、関係を、視覚的に、表現するものであることを、理解する。
*   ER図の、基本的な、記法（エンティティ、アトリビュート、リレーションシップ）を、読み取れるようになる。

---

## 導入

これまでの、セクションで、データベースの、基本的な、考え方として、「テーブルを、適切に、分割し、キーで、関係付ける」ことの、重要性を、学んできました。では、具体的に、**「どのように、分割すれば、適切なのか？」**という、疑問が、湧いてくるはずです。

その、設計指針となるのが、**正規化（Normalization）**という、理論です。また、その、設計結果を、視覚的に、分かりやすく、表現するための、図が、**ER図（Entity-Relationship Diagram）**です。

このセクションでは、データベース設計の、入り口として、正規化の、基本的な、考え方と、ER図の、読み方について学びます。これらは、少し、理論的な、内容に、なりますが、良い、データベースを、設計するための、揺るぎない、土台となります。「今は、完全に、理解できなくても、大丈夫」という、気持ちで、まずは、全体像を、掴んでいきましょう。

---

## 詳細解説

### 🧼 正規化 (Normalization): テーブルを「お掃除」する手順

**正規化**とは、一言で言えば、**データの、重複（冗長性）を、排除し、データの、一貫性を、保ちやすくするために、テーブルを、分割していく、一連の、ルールのこと**です。散らかった、部屋を、ルールに、従って、整理整頓していく、作業に、似ています。

正規化には、いくつかの、段階があり、それぞれ、**第1正規形、第2正規形、第3正規形...** と呼ばれます。実務では、多くの場合、第3正規形まで、満たされていれば、十分に、良い設計と、見なされます。

#### 第1正規形: 「一つのマスには、一つの値」

**第1正規形**の、ルールは、非常に、シンプルです。

> **ルール: テーブルの、一つの、セル（マス）には、一つの、値しか、含めてはならない。**

**悪い例（非正規形）**

| 注文ID | 顧客名 | 購入商品 |
| :--- | :--- | :--- |
| 101 | 山田 太郎 | りんご, みかん |
| 102 | 鈴木 花子 | ぶどう |

この表では、「購入商品」カラムに、「りんご, みかん」という、**複数の値が、カンマ区切りで、入ってしまっています**。これは、第1正規形の、ルールに、違反しています。なぜなら、これでは、「りんご」だけで、検索したり、商品の、個数を、集計したりすることが、非常に、困難になるからです。

**良い例（第1正規形）**

この問題を、解決するには、レコードを、分割します。

| 注文ID | 顧客名 | 購入商品 |
| :--- | :--- | :--- |
| 101 | 山田 太郎 | りんご |
| 101 | 山田 太郎 | みかん |
| 102 | 鈴木 花子 | ぶどう |

これで、一つの、セルには、一つの、値しか、入っていない、状態になりました。これが、第1正規形です。

#### 第2正規形: 「部分的な依存をなくす」

第2正規形は、**複合主キー**（複数の、カラムを、組み合わせて、主キーとする場合）に、関連する、ルールです。少し、複雑ですが、考え方は、「**主キーの、一部だけに、依存している、カラムを、別の、テーブルに、切り出す**」というものです。

**悪い例（第1正規形だが、第2正規形ではない）**

主キーが `(注文ID, 商品ID)` の、複合主キーである、テーブルを、考えます。

| `注文ID` | `商品ID` | 注文日 | 商品名 | 単価 | 数量 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 101 | P01 | 2023-10-26 | りんご | 150 | 3 |
| 101 | P02 | 2023-10-26 | みかん | 100 | 5 |
| 102 | P03 | 2023-10-27 | ぶどう | 500 | 1 |

このテーブルでは、
*   `注文日`は、`注文ID`だけで、決まります。（`商品ID`には、依存しない）
*   `商品名`と`単価`は、`商品ID`だけで、決まります。（`注文ID`には、依存しない）
*   `数量`は、`注文ID`と`商品ID`の、両方があって、初めて、決まります。

このように、`注文日`や、`商品名`などが、主キーの、**一部にしか、依存していない**状態を、部分関数従属（用語として覚える必要はない）と呼びます。これを、解消するために、テーブルを、分割します。

**良い例（第2正規形）**

1.  **注文テーブル**: `注文ID`に、依存する情報
    | `注文ID` | 注文日 |
    | :--- | :--- |
    | 101 | 2023-10-26 |
    | 102 | 2023-10-27 |
2.  **商品テーブル**: `商品ID`に、依存する情報
    | `商品ID` | 商品名 | 単価 |
    | :--- | :--- | :--- |
    | P01 | りんご | 150 |
    | P02 | みかん | 100 |
    | P03 | ぶどう | 500 |
3.  **注文明細テーブル**: `注文ID`と`商品ID`の、両方に、依存する情報
    | `注文ID` | `商品ID` | 数量 |
    | :--- | :--- | :--- |
    | 101 | P01 | 3 |
    | 101 | P02 | 5 |
    | 102 | P03 | 1 |

これで、部分関数従属が、解消され、第2正規形を、満たしたことになります。

#### 第3正規形: 「主キー以外への依存をなくす」

第3正規形の、ルールは、「**主キー以外の、カラムに、依存している、カラムを、別の、テーブルに、切り出す**」というものです。これを、推移的関数従属（用語として覚える必要はない）の、解消と呼びます。

**悪い例（第2正規形だが、第3正規形ではない）**

社員情報を、管理する、テーブルを、考えます。主キーは `社員ID` です。

| `社員ID` | 氏名 | 所属部署ID | 所属部署名 |
| :--- | :--- | :--- | :--- |
| E01 | 山田 太郎 | D01 | 営業部 |
| E02 | 鈴木 花子 | D02 | 開発部 |
| E03 | 佐藤 次郎 | D01 | 営業部 |

このテーブルでは、`所属部署名`は、主キーである `社員ID` に、直接、依存しているわけでは、ありません。`所属部署名`は、`所属部署ID`によって、決まります。つまり、`社員ID` → `所属部署ID` → `所属部署名` という、**推移的な、依存関係**が、存在します。

これでは、「営業部」が、「第一営業部」に、名称変更された場合、`所属部署ID`が`D01`の、全ての、レコードを、修正する必要があり、更新異常の、原因となります。

**良い例（第3正規形）**

この、推移的依存を、解消するために、部署情報を、別の、テーブルに、切り出します。

1.  **社員テーブル**
    | `社員ID` | 氏名 | 所属部署ID |
    | :--- | :--- | :--- |
    | E01 | 山田 太郎 | D01 |
    | E02 | 鈴木 花子 | D02 |
    | E03 | 佐藤 次郎 | D01 |
2.  **部署テーブル**
    | `部署ID` | 部署名 |
    | :--- | :--- |
    | D01 | 営業部 |
    | D02 | 開発部 |

これで、部署名が、変更されても、部署テーブルの、1行を、修正するだけで、済みます。これが、第3正規形です。

### 🗺️ ER図 (Entity-Relationship Diagram): データベースの設計図

**ER図**とは、データベースの、**テーブル（エンティティ）**と、その、**カラム（アトリビュート）**、そして、テーブル間の、**関係（リレーションシップ）**を、視覚的に、表現した、設計図のことです。

家を、建てる前に、設計図が、必要なように、複雑な、システムを、作る際には、データベースの、設計図である、ER図が、不可欠です。

#### ER図の基本記法 (IE記法)

ER図には、いくつかの、記法がありますが、ここでは、最も、一般的な、**IE記法（鳥の足記法）**を、紹介します。

**[ここに、顧客、注文、商品の、3つの、テーブルからなる、ER図の、画像を、挿入]**

```
+-------------+       +-------------+       +-----------------+
| customers   |       | orders      |       | order_details   |
+-------------+       +-------------+       +-----------------+
| id (PK)     |-------<| id (PK)     |-------<| id (PK)         |
| name        |       | customer_id (FK) |    | order_id (FK)   |
| email       |       | order_date  |       | product_id (FK) |
+-------------+       +-------------+       | quantity        |
                                          +-----------------+
                                              ^
                                              |
                                          +---v---------+
                                          | products    |
                                          +-------------+
                                          | id (PK)     |
                                          | name        |
                                          | price       |
                                          +-------------+
```

*   **エンティティ (Entity)**: 四角形で、表現され、データベースの、**テーブル**に、相当します。（例: `customers`, `orders`）
*   **アトリビュート (Attribute)**: エンティティの中に、記述され、テーブルの、**カラム**に、相当します。主キーには `(PK)`、外部キーには `(FK)` と、印を付けます。
*   **リレーションシップ (Relationship)**: エンティティ間を、結ぶ、線で、表現されます。線の、両端の、記号（**カーディナリティ**）が、テーブル間の、関係（1対1、1対多、多対多）を、示します。
    *   `---` (一本線): 「1」を、表す。
    *   `---<` (鳥の足): 「多」を、表す。

上の図は、以下のような、関係を、示しています。

*   `customers` と `orders` の関係: `customers` の、一本線と、`orders` の、鳥の足が、繋がっているので、「**一人の、顧客は、複数の、注文を、持つことができる（1対多）**」と、読み取れます。
*   `orders` と `order_details` の関係: 「**一つの、注文は、複数の、注文明細を、持つことができる（1対多）**」
*   `products` と `order_details` の関係: 「**一つの、商品は、複数の、注文明細に、登場することができる（1対多）**」

ER図を、描くことで、データベースの、全体像を、俯瞰し、チームメンバーと、設計について、議論したり、実装時の、参照資料として、使ったりすることができます。

---

## ✨ まとめ

このセクションでは、データベース設計の、基礎となる、正規化と、ER図について学びました。

*   **正規化**: データの、重複をなくし、一貫性を、保つために、テーブルを、分割していく、設計手順。
    *   **第1正規形**: 1つの、セルに、1つの、値。
    *   **第2正規形**: 主キーの、一部だけに、依存する、カラムを、分離。
    *   **第3正規形**: 主キー以外の、カラムに、依存する、カラムを、分離。
*   **ER図**: データベースの、設計図。テーブル（**エンティティ**）、カラム（**アトリビュート**）、テーブル間の、関係（**リレーションシップ**）を、視覚的に、表現する。
*   IE記法では、線の、端の、記号（カーディナリティ）で、**1対多**などの、関係を、示す。

正規化や、ER図は、奥が深く、専門的に、学ぶと、非常に、高度な、内容に、なります。しかし、初学者の段階では、「**なぜ、正規化が、必要なのか**」という、根本的な、理由と、「**ER図が、何を表しているのか**」を、大まかに、読み取れるレベルで、あれば、十分です。これらの、知識は、今後の、Laravelでの、開発において、モデル間の、関係を、定義する際に、必ず、役立ちます。

---
