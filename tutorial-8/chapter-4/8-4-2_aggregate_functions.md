
# Tutorial 8-4-2: データの集計とグループ化

> 📌 **使用するデータベースとテーブル**：引き続き`practice_db`データベースと、Chapter 2・3で作成したテーブルを使用します。

## 🎯 このセクションで学ぶこと

*   「集計関数」の役割を理解し、代表的な関数（`COUNT`, `SUM`, `AVG`, `MAX`, `MIN`）を使えるようになる。
*   `GROUP BY`句を使って、特定のカラムの値に基づいてレコードをグループ化し、グループごとに集計できるようになる。
*   `AS`を使って、集計結果のカラムに分かりやすい別名を付けられるようになる。
*   `HAVING`句を使って、`GROUP BY`で集計した**結果に対して**さらに条件を指定して絞り込めるようになる。
*   `WHERE`句と`HAVING`句の役割の違いを明確に説明できるようになる。

---

## 導入：データから「洞察」を得る

これまでの学習で、私たちはデータベースから特定のレコードを取り出したり、並べ替えたりする方法を学びました。しかし、ビジネスの現場では、個々のデータそのものよりも、「データ全体から何が言えるのか」という**洞察（インサイト）**が求められます。

*   「全ユーザーの数は何人か？」
*   「商品の平均価格はいくらか？」
*   「各カテゴリーで最も高価な商品は何か？」
*   「どのユーザーが最も多くの投稿をしているか？」

このような問いに答えるためには、個々のレコードを眺めているだけでは不十分です。データを特定のグループにまとめ、そのグループごとに合計値、平均値、件数などを計算する必要があります。これを実現するのが、**集計関数（Aggregate Functions）**と**`GROUP BY`**句です。

このセクションで学ぶ内容は、単なるデータ取得から一歩進んで、データ分析の領域に足を踏み入れるための重要なステップです。これらの機能を使いこなすことで、アプリケーションに「ランキング機能」や「統計情報表示機能」などを実装できるようになります。

---

## 詳細解説

### 🔢 集計関数：データを一つの値に要約する

集計関数は、複数のレコードの値を受け取り、それを要約した単一の値を返します。`SELECT`句の中で使います。

| 関数 | 説明 | 例 |
| :--- | :--- | :--- |
| `COUNT(カラム名)` | レコードの**件数**を数える。`COUNT(*)`とすると全件数。 | `COUNT(id)` → ユーザー数 |
| `SUM(カラム名)` | 数値カラムの**合計値**を計算する。 | `SUM(price)` → 売上合計 |
| `AVG(カラム名)` | 数値カラムの**平均値**を計算する。 | `AVG(score)` → 平均評価点 |
| `MAX(カラム名)` | カラムの**最大値**を求める。 | `MAX(price)` → 最高価格 |
| `MIN(カラム名)` | カラムの**最小値**を求める。 | `MIN(price)` → 最低価格 |

**例：`users`テーブルの総ユーザー数を取得する**
```sql
SELECT COUNT(id) FROM users;
```
この結果、`COUNT(id)`という名前のカラムにユーザー数が表示されます。これでは分かりにくいので、`AS`を使って別名を付けましょう。

```sql
SELECT COUNT(id) AS total_users FROM users;
```
これで、`total_users`というカラム名で結果が返ってくるようになり、アプリケーション側で扱いやすくなります。

### 🗂️ `GROUP BY`句：グループごとの集計

集計関数は、テーブル全体のデータを対象にすることが多いですが、その真価は`GROUP BY`句と組み合わせることで発揮されます。`GROUP BY`は、指定したカラムの値が同じレコードを一つのグループにまとめ、そのグループごとに集計関数を適用します。

**例：どのユーザーが、それぞれ何件の投稿をしているか？**

この問いに答えるには、`posts`テーブルを`user_id`でグループ化し、各グループのレコード数（投稿数）を`COUNT`で数える必要があります。

```sql
SELECT
    user_id,
    COUNT(id) AS post_count
FROM
    posts
GROUP BY
    user_id;
```

**[ここに、上記SQLの実行結果のスクリーンショットを挿入。`user_id`と`post_count`が並んだ表]**

| user_id | post_count |
|:---|:---|
| 1 | 5 |
| 2 | 3 |
| 4 | 8 |

このSQLの内部的な動きは以下の通りです。

1.  `FROM posts`: `posts`テーブルからデータを取得する。
2.  `GROUP BY user_id`: `user_id`カラムの値が同じレコードをグループに分ける。（`user_id=1`のグループ、`user_id=2`のグループ...）
3.  `SELECT user_id, COUNT(id)`: 各グループに対して`SELECT`句が適用される。`user_id`はそのグループの`user_id`の値、`COUNT(id)`はそのグループに含まれるレコードの件数を計算する。

`JOIN`と組み合わせることで、さらに有益な情報を得られます。

**例：ユーザー名付きで、投稿数をランキング表示する**
```sql
SELECT
    u.name,
    COUNT(p.id) AS post_count
FROM
    users AS u
JOIN
    posts AS p ON u.id = p.user_id
GROUP BY
    u.id, u.name -- グループ化のキーにnameも追加
ORDER BY
    post_count DESC;
```
*注意：`SELECT`句で指定した非集計カラム（`u.name`など）は、`GROUP BY`句にも指定する必要があります（MySQLのバージョンによっては不要な場合もありますが、明記するのが標準的で安全です）。*

### 絞り込みの使い分け：`WHERE` vs `HAVING`

`GROUP BY`を使う際、絞り込み条件をどこに書くかで`WHERE`と`HAVING`を使い分ける必要があります。これは非常に重要な違いです。

*   **`WHERE`句**: **グループ化する前**の、個々のレコードに対して条件を指定する。
*   **`HAVING`句**: **グループ化した後**の、集計結果に対して条件を指定する。

SQLの実行順序で考えると分かりやすいです： `FROM` → **`WHERE`** → **`GROUP BY`** → **`HAVING`** → `SELECT` → `ORDER BY`

**例：投稿数が3件以上のユーザーだけを表示したい**

「投稿数が3件以上」という条件は、`COUNT(p.id)`という**集計結果**に対する条件です。したがって、`GROUP BY`の後に実行される`HAVING`句を使います。

```sql
SELECT
    u.name,
    COUNT(p.id) AS post_count
FROM
    users AS u
JOIN
    posts AS p ON u.id = p.user_id
GROUP BY
    u.id, u.name
HAVING
    post_count >= 3 -- HAVING COUNT(p.id) >= 3 とも書ける
ORDER BY
    post_count DESC;
```
もしこれを`WHERE COUNT(p.id) >= 3`と書くと、`WHERE`句はグループ化の前に評価されるため、集計関数（`COUNT`）がまだ使えずエラーになります。

**例：タイトルに「PHP」を含む投稿に限定して、ユーザーごとの投稿数を集計する**

「タイトルに『PHP』を含む」という条件は、グループ化する前の個々の`posts`レコードに対する条件です。したがって、`WHERE`句を使います。

```sql
SELECT
    u.name,
    COUNT(p.id) AS post_count
FROM
    users AS u
JOIN
    posts AS p ON u.id = p.user_id
WHERE
    p.title LIKE '%PHP%'
GROUP BY
    u.id, u.name
ORDER BY
    post_count DESC;
```

---

## ✨ まとめ

このセクションでは、データを要約し、分析するための集計関数と`GROUP BY`句について学びました。

*   `COUNT`, `SUM`, `AVG`, `MAX`, `MIN`などの集計関数を使うことで、データセット全体の特徴を一つの数値として把握できる。
*   `GROUP BY`句は、特定のカラムの値に基づいてレコードをグループ化し、グループごとに集計を行うための強力な機能である。
*   `AS`を使って集計結果のカラムに別名を付けることで、クエリの結果が分かりやすくなり、`HAVING`句や`ORDER BY`句で参照しやすくなる。
*   絞り込み条件の使い分けが重要：
    *   `WHERE`は、**グループ化する前**の元データに対する条件。
    *   `HAVING`は、**グループ化した後**の集計結果に対する条件。

`GROUP BY`と`HAVING`を使いこなせるようになると、単純なデータ表示だけでなく、アプリケーションに統計的な側面を持たせることができます。これは、より高度で価値のある機能開発への扉を開くスキルです。

次のセクションでは、SQLの学習の総仕上げとして、より複雑なクエリを構築するための「サブクエリ」について学びます。

---
