# Tutorial 12-1-6: CORSとは

## 🎯 このセクションで学ぶこと

*   CORSとは何かを理解する。
*   なぜCORSが必要なのかを学ぶ。
*   LaravelでCORSを設定する方法を学ぶ。
*   CORSエラーの対処法を理解する。

---

## 🧠 先輩エンジニアの思考プロセス

### 「なぜAPIルートの後に『CORS』を学ぶのか？」

APIルートを定義したら、次は「CORS」です。

---

### 理由1: フロントエンドからのアクセス

フロントエンドとバックエンドが**別のドメイン**で動いている場合、CORSの設定が必要です。

例：
- フロントエンド: `http://localhost:3000`
- バックエンド: `http://localhost:8000`

---

### 理由2: セキュリティの仕組み

ブラウザは、**異なるオリジンへのリクエストを制限**しています。

これは「同一オリジンポリシー」というセキュリティ機能です。

CORSを設定することで、**許可されたオリジンからのアクセス**を受け入れます。

---

### 理由3: 本番環境でも必要

開発環境だけでなく、**本番環境でもCORSの設定**が必要です。

適切に設定しないと、フロントエンドからAPIにアクセスできません。

---

### このセクションでやること

| 順番 | 作業 | 理由 |
|------|------|------|
| 1 | CORSの概念を理解 | なぜ必要なのかを学ぶ |
| 2 | LaravelのCORS設定 | `config/cors.php`の編集 |
| 3 | 動作確認 | 異なるオリジンからのアクセステスト |

> 💡 **ポイント**: CORSは「Cross-Origin Resource Sharing」の略で、異なるオリジン間でのリソース共有を制御します。

---

## 導入：なぜCORSが必要なのか

APIを開発していると、**CORSエラー**に遭遇することがあります。

```
Access to fetch at 'http://localhost:8000/api/tasks' from origin 'http://localhost:3000' has been blocked by CORS policy
```

これは、**ブラウザのセキュリティ機能**によるものです。

---

## 詳細解説

### 🔍 CORSとは

**CORS（Cross-Origin Resource Sharing）**は、**異なるオリジン間でのリソース共有を制御する仕組み**です。

**オリジン**とは、**プロトコル + ドメイン + ポート**の組み合わせです。

**例**:

*   `http://localhost:8000`
*   `http://localhost:3000`
*   `https://example.com`

---

### 🔍 同一オリジンポリシー

ブラウザには、**同一オリジンポリシー**というセキュリティ機能があります。

**同一オリジンポリシー**は、**異なるオリジンからのリクエストを制限する**仕組みです。

**例**:

*   `http://localhost:3000`から`http://localhost:8000`へのリクエストは、**異なるオリジン**とみなされる
*   ブラウザは、このリクエストをブロックする

---

### 🔍 なぜCORSが必要なのか

**CORS**を設定すると、**異なるオリジンからのリクエストを許可**できます。

**例**:

*   フロントエンド（React、Vue.js）: `http://localhost:3000`
*   バックエンド（Laravel API）: `http://localhost:8000`

この場合、**CORS設定が必要**です。

---

### 🔍 CORSの仕組み

ブラウザは、異なるオリジンへのリクエストを送信する前に、**プリフライトリクエスト**を送信します。

**プリフライトリクエスト**:

*   HTTPメソッド: `OPTIONS`
*   目的: サーバーがCORSを許可しているか確認する

サーバーが許可している場合、ブラウザは本来のリクエストを送信します。

---

### 🔍 LaravelでのCORS設定

Laravelには、**CORS設定**が標準で用意されています。

**ファイル**: `config/cors.php`

```php
<?php

return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],

    'allowed_methods' => ['*'],

    'allowed_origins' => ['*'],

    'allowed_origins_patterns' => [],

    'allowed_headers' => ['*'],

    'exposed_headers' => [],

    'max_age' => 0,

    'supports_credentials' => false,
];
```

**ポイント**:
*   `paths`: CORSを適用するパス
*   `allowed_methods`: 許可するHTTPメソッド
*   `allowed_origins`: 許可するオリジン
*   `allowed_headers`: 許可するヘッダー

---

### 🔍 開発環境でのCORS設定

開発環境では、**すべてのオリジンを許可**します。

```php
'allowed_origins' => ['*'],
```

**注意**: 本番環境では、**特定のオリジンだけを許可**します。

---

### 🔍 本番環境でのCORS設定

本番環境では、**特定のオリジンだけを許可**します。

```php
'allowed_origins' => [
    'https://example.com',
    'https://www.example.com',
],
```

---

### 🔍 環境変数を使ったCORS設定

環境変数を使って、CORS設定を管理できます。

**ファイル**: `.env`

```
FRONTEND_URL=http://localhost:3000
```

**ファイル**: `config/cors.php`

```php
'allowed_origins' => [
    env('FRONTEND_URL', 'http://localhost:3000'),
],
```

---

### 🔍 実践演習: CORS設定を確認してください

以下の手順で、CORS設定を確認してください。

1.  `config/cors.php`を開く
2.  `allowed_origins`を確認する
3.  `['*']`になっているか確認する

---

### 🔍 CORSエラーの対処法

CORSエラーが発生した場合、以下を確認します。

**1. config/cors.phpの設定を確認する**

```php
'allowed_origins' => ['*'],
```

---

**2. ミドルウェアが適用されているか確認する**

**ファイル**: `app/Http/Kernel.php`

```php
protected $middleware = [
    // ...
    \Fruitcake\Cors\HandleCors::class,
];
```

---

**3. キャッシュをクリアする**

```bash
php artisan config:clear
php artisan cache:clear
```

---

### 🔍 CORSとCSRFの違い

**CORS**と**CSRF**は、異なるセキュリティ機能です。

| 項目 | CORS | CSRF |
|------|------|------|
| **目的** | 異なるオリジンからのリクエストを制御 | 偽造リクエストを防ぐ |
| **適用** | API | Webページ |
| **ヘッダー** | `Access-Control-Allow-Origin` | `X-CSRF-TOKEN` |

---

### 💡 TIP: プリフライトリクエストをキャッシュする

プリフライトリクエストをキャッシュすると、パフォーマンスが向上します。

```php
'max_age' => 86400, // 24時間
```

---

### 🚨 よくある間違い

#### 間違い1: 本番環境でallowed_originsを['*']にする

本番環境では、**特定のオリジンだけを許可**します。

```php
// ❌ 間違い（本番環境）
'allowed_origins' => ['*'],

// ✅ 正しい（本番環境）
'allowed_origins' => [
    'https://example.com',
],
```

---

#### 間違い2: CORSエラーをサーバー側のエラーと勘違いする

CORSエラーは、**ブラウザ側のエラー**です。

**対処法**: サーバー側でCORS設定を行います。

---

#### 間違い3: CORSとCSRFを混同する

CORSとCSRFは、異なるセキュリティ機能です。

*   **CORS**: 異なるオリジンからのリクエストを制御
*   **CSRF**: 偽造リクエストを防ぐ

---

## ✨ まとめ

このセクションでは、CORSについて学びました。

*   CORSとは何かを理解した。
*   なぜCORSが必要なのかを学んだ。
*   LaravelでCORSを設定する方法を学んだ。
*   CORSエラーの対処法を理解した。

これで、Chapter 1（API開発の基礎）は完了です。次のChapter 2では、RESTful APIの実装について学びます。

---

## 📝 学習のポイント

- [ ] CORSとは何かを理解した。
- [ ] 同一オリジンポリシーを理解した。
- [ ] LaravelでCORSを設定した。
- [ ] CORSエラーの対処法を理解した。
