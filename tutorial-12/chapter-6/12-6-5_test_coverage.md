# Tutorial 12-6-5: テストカバレッジの確認

## 🎯 このセクションで学ぶこと

- テストカバレッジとは何かを理解する
- テストカバレッジを確認する方法を学ぶ
- テストの網羅性を高める方法を学ぶ
- テストのベストプラクティスを理解する

---

## 🧠 先輩エンジニアの思考プロセス

### 「なぜ最後に『テストカバレッジ』を確認するのか？」

テストを書いたら、最後は「カバレッジの確認」です。

---

### 理由1: テストの網羅性を確認

テストカバレッジは、**コードのどの部分がテストされているか**を示します。

カバレッジが低い部分は、テストが不足している可能性があります。

---

### 理由2: 100%を目指す必要はない

カバレッジ100%を目指すと、**テストのためのテスト**になりがちです。

重要な機能から優先的にテストを書くことが大切です。

---

### 理由3: CI/CDの準備

テストカバレッジを継続的に監視することで、**品質の低下を防ぐ**ことができます。

CI/CDパイプラインに組み込むことで、自動的にチェックできます。

---

### このセクションでやること

| 順番 | 作業 | 理由 |
|------|------|------|
| Step 1 | カバレッジの基礎を理解 | 指標の意味を把握 |
| Step 2 | カバレッジレポートを生成 | どこがテストされているか確認 |
| Step 3 | テストのベストプラクティス | 品質の高いテストを書く |
| Step 4 | CI/CDでテストを自動化 | 継続的な品質管理 |

> 💡 **ポイント**: 100%のカバレッジを目指す必要はありません。重要な機能を優先しましょう。

---

## Step 1: テストカバレッジの基礎

### 1-1. テストカバレッジとは

**テストカバレッジ**は、以下の指標で表されます。

| 指標 | 説明 |
|------|------|
| 行カバレッジ | 実行された行の割合 |
| 関数カバレッジ | 実行された関数の割合 |
| 分岐カバレッジ | 実行された分岐の割合 |

---

### 1-2. カバレッジの目標

| カバレッジ | 評価 |
|------------|------|
| 80%以上 | 良好 |
| 90%以上 | 優秀 |
| 100% | 理想的（ただし、現実的には難しい） |

---

### 1-3. カバレッジだけでは不十分

**テストカバレッジが高い**からといって、**テストの質が高い**とは限りません。

- 正常系だけでなく、異常系もテストする
- エッジケースもテストする
- テストの意図を明確にする

---

## Step 2: テストカバレッジを確認する

### 2-1. Xdebugのインストール

テストカバレッジを確認するには、**Xdebug**が必要です。

```bash
# Xdebugをインストール
sudo apt-get install php-xdebug

# Xdebugが有効になっているか確認
php -v
```

---

### 2-2. カバレッジレポートを生成する

```bash
./vendor/bin/phpunit --coverage-html coverage
```

`coverage/index.html`をブラウザで開くと、テストカバレッジが表示されます。

---

### 2-3. レポートの見方

| 色 | 意味 |
|----|------|
| 緑色 | テストされている行 |
| 赤色 | テストされていない行 |
| 黄色 | 一部の分岐がテストされていない行 |

---

### 2-4. テストされていない箇所を見つける

テストカバレッジのレポートを見て、**赤色の行**を見つけます。

その行をテストするテストケースを追加します。

---

### 2-5. 実践演習

以下のテストを追加して、テストカバレッジを高めてください。

**テスト内容**: 優先度が5を超える場合、タスクを作成できないことを確認する

**解答例**:

```php
public function test_優先度が5を超える場合タスクを作成できない()
{
    // 準備
    $user = User::factory()->create();
    
    // 実行
    $response = $this->actingAs($user)->post('/tasks', [
        'title' => 'テストタスク',
        'description' => 'テスト説明',
        'status' => 'pending',
        'priority' => 6,
    ]);
    
    // 検証
    $response->assertStatus(302);
    $response->assertSessionHasErrors('priority');
    $this->assertDatabaseMissing('tasks', [
        'title' => 'テストタスク',
    ]);
}
```

---

## Step 3: テストのベストプラクティス

### 3-1. テストの原則

| 原則 | 説明 |
|------|------|
| 独立性 | 他のテストに依存しない |
| 高速性 | 数秒以内に実行できる |
| 可読性 | 何をテストしているか分かりやすい |
| 保守性 | コードが変わっても、テストを修正しやすい |

---

### 3-2. テストの命名規則

```php
public function test_何をテストするか()
{
    // ...
}
```

**例**:

- `test_ログインしたユーザーがタスクを作成できる()`
- `test_タイトルが空の場合タスクを作成できない()`
- `test_他人のタスクを更新できない()`

---

### 3-3. テストの整理

テストが増えてきたら、以下のように整理します。

| 整理方法 | 例 |
|----------|-----|
| ファイルごと | `TaskTest.php`、`UserTest.php` |
| メソッドごと | `test_create()`、`test_update()` |
| 正常系・異常系 | `test_正常系()`、`test_異常系()` |

---

### 3-4. テストのリファクタリング

テストもリファクタリングします。

- **重複コードを削除する**: `setUp()`メソッドを使う
- **ヘルパーメソッドを作る**: `createTask()`、`createUser()`
- **データプロバイダーを使う**: 複数のパターンをテストする

---

## Step 4: CI/CDでテストを自動化する

### 4-1. テストの実行を高速化する

| 方法 | コマンド |
|------|---------|
| 並列実行 | `php artisan test --parallel` |
| メモリDB | `DB_DATABASE=:memory:` |
| スキップ | `$this->markTestSkipped()` |

---

### 4-2. GitHub Actionsの例

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
      - name: Install Dependencies
        run: composer install
      - name: Run Tests
        run: php artisan test
```

---

## 🚨 よくある間違い

### 間違い1: テストカバレッジだけを追求する

**問題**: カバレッジが100%でも、テストの質が低ければ意味がない

**対処法**: 正常系だけでなく、異常系もテストします。

---

### 間違い2: テストを書かない

**問題**: 「時間がない」という理由で、テストを書かないのは危険

**対処法**: 最初から少しずつテストを書きます。

---

### 間違い3: テストが遅い

**問題**: テストが遅いと、開発効率が下がる

**対処法**: 並列実行やメモリ上のデータベースを使います。

---

## 💡 TIP: Pest PHPを使う

**Pest PHP**は、PHPUnitの代替テストフレームワークです。

より簡潔にテストを書けます。

```php
it('can create a task', function () {
    $user = User::factory()->create();
    
    $response = $this->actingAs($user)->post('/tasks', [
        'title' => 'Test Task',
        'description' => 'Test Description',
        'status' => 'pending',
        'priority' => 3,
    ]);
    
    $response->assertStatus(302);
    expect(Task::count())->toBe(1);
});
```

---

## ✨ まとめ

このセクションでは、テストカバレッジの確認を学びました。

| Step | 学んだこと |
|------|-----------|
| Step 1 | テストカバレッジの基礎 |
| Step 2 | カバレッジレポートの生成と確認 |
| Step 3 | テストのベストプラクティス |
| Step 4 | CI/CDでテストを自動化 |

これで、Tutorial 11（Laravel実践講座）は完了です。お疲れさまでした！

---
## 🎉 Tutorial 11の完了

Tutorial 11（Laravel実践講座）を完了しました！

このチュートリアルでは、以下のことを学びました。

| Chapter | 内容 |
|---------|------|
| Chapter 1 | 要件定義とデータベース設計 |
| Chapter 2 | CRUD機能の実装 |
| Chapter 3 | 認証とリレーションシップ |
| Chapter 4 | セキュリティ対策 |
| Chapter 5 | リファクタリング |
| Chapter 6 | テスト |

次のTutorial 12では、API開発について学びます。
