# Tutorial 9-1-5.5: リクエストとレスポンスの基礎

## 🎯 このセクションで学ぶこと

*   HTTPリクエストとレスポンスの概念を理解する。
*   `Request`オブジェクトを使って、ユーザーからの入力データを取得できるようになる。
*   様々な形式のレスポンス（ビュー、JSON、リダイレクト）を返せるようになる。

---

## 導入：Webアプリケーションの「会話」

Webアプリケーションは、ユーザー（ブラウザ）とサーバーの「会話」で成り立っています。

1. **リクエスト（Request）**: ユーザーがブラウザでURLにアクセスしたり、フォームを送信したりすると、サーバーに「リクエスト」が送られます。
2. **レスポンス（Response）**: サーバーはリクエストを処理し、HTMLページやJSONデータなどの「レスポンス」を返します。

Laravelでは、この「リクエスト」と「レスポンス」を簡単に扱うための機能が用意されています。

---

## 詳細解説

### 📥 リクエスト（Request）とは

リクエストには、以下のような情報が含まれています。

| 情報 | 説明 | 例 |
|:---|:---|:---|
| **URL** | アクセス先のURL | `/users/1` |
| **HTTPメソッド** | リクエストの種類 | GET, POST, PUT, DELETE |
| **クエリパラメータ** | URLの`?`以降のパラメータ | `?page=2&sort=name` |
| **フォームデータ** | POSTで送信されたデータ | `name=山田&email=yamada@example.com` |
| **ヘッダー** | メタ情報 | `Content-Type`, `Authorization` |
| **Cookie** | ブラウザに保存されたデータ | セッションIDなど |

Laravelでは、これらの情報を`Request`オブジェクトを通じて取得できます。

---

### 🛠️ Requestオブジェクトの取得

コントローラーのメソッドで、`Request`オブジェクトを引数として受け取ることができます。

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class UserController extends Controller
{
    public function store(Request $request)
    {
        // $request を使ってリクエストの情報を取得
    }
}
```

**コードリーディング**

*   `use Illuminate\Http\Request;`: `Request`クラスをインポートします。
*   `Request $request`: 引数に`Request`型を指定すると、Laravelが自動的に`Request`オブジェクトを注入します（依存性注入）。

---

### 📝 フォームデータの取得

フォームから送信されたデータを取得する方法を学びましょう。

#### `input()` - 値を取得する（最も基本的）

```php
// 'name'フィールドの値を取得
$name = $request->input('name');

// デフォルト値を指定（値がない場合に使用）
$name = $request->input('name', 'ゲスト');
```

#### `all()` - 全ての入力データを取得

```php
// 全てのフォームデータを配列で取得
$data = $request->all();

// 例: ['name' => '山田', 'email' => 'yamada@example.com']
```

#### `only()` - 指定したフィールドのみ取得

```php
// 'name'と'email'のみ取得
$data = $request->only(['name', 'email']);
```

#### `except()` - 指定したフィールドを除外して取得

```php
// '_token'を除外して取得（CSRFトークンを除外するときに便利）
$data = $request->except(['_token']);
```

---

### 🔍 クエリパラメータの取得

URLの`?`以降のパラメータ（クエリパラメータ）を取得する方法です。

例えば、`/users?page=2&sort=name`というURLの場合：

```php
// クエリパラメータを取得
$page = $request->query('page');      // '2'
$sort = $request->query('sort');      // 'name'

// デフォルト値を指定
$page = $request->query('page', 1);   // 値がなければ 1

// 全てのクエリパラメータを取得
$queryParams = $request->query();     // ['page' => '2', 'sort' => 'name']
```

> 💡 **TIP**: `input()`メソッドは、フォームデータとクエリパラメータの両方から値を取得できます。明示的にクエリパラメータのみを取得したい場合は`query()`を使います。

---

### ✅ 値の存在チェック

フォームデータが存在するかどうかを確認するメソッドです。

#### `has()` - キーが存在するか確認

```php
if ($request->has('name')) {
    // 'name'キーが存在する（値が空でも true）
}

// 複数のキーを同時にチェック
if ($request->has(['name', 'email'])) {
    // 'name'と'email'の両方が存在する
}
```

#### `filled()` - 値が空でないか確認

```php
if ($request->filled('name')) {
    // 'name'が存在し、かつ空でない
}
```

#### `missing()` - キーが存在しないか確認

```php
if ($request->missing('name')) {
    // 'name'キーが存在しない
}
```

#### 比較表

| メソッド | 値がない | 値が空文字 | 値がある |
|:---|:---|:---|:---|
| `has()` | false | true | true |
| `filled()` | false | false | true |
| `missing()` | true | false | false |

---

### 📁 ファイルアップロードの取得

フォームからアップロードされたファイルを取得する方法です。

```php
// ファイルを取得
$file = $request->file('avatar');

// ファイルが存在するか確認
if ($request->hasFile('avatar')) {
    // ファイルが有効か確認
    if ($request->file('avatar')->isValid()) {
        // ファイルを保存
        $path = $request->file('avatar')->store('avatars');
    }
}
```

**コードリーディング**

*   `$request->file('avatar')`: `avatar`という名前のファイルを取得します。
*   `hasFile()`: ファイルがアップロードされたか確認します。
*   `isValid()`: ファイルが正常にアップロードされたか確認します。
*   `store('avatars')`: `storage/app/avatars`ディレクトリにファイルを保存します。

---

### 📤 レスポンス（Response）の返し方

コントローラーのメソッドは、様々な形式でレスポンスを返すことができます。

#### 1. ビューを返す

最も一般的な方法です。HTMLページを返します。

```php
// シンプルにビューを返す
return view('users.index');

// データをビューに渡す
return view('users.index', ['users' => $users]);

// compact()を使う（変数名と同じキーで渡す）
return view('users.index', compact('users'));
```

#### 2. 文字列を返す

シンプルなテキストを返します。

```php
return 'Hello, World!';
```

#### 3. JSONを返す（API用）

APIを作成する際に使用します。

```php
// 基本的なJSONレスポンス
return response()->json([
    'message' => '成功しました',
    'data' => $users
]);

// ステータスコードを指定
return response()->json([
    'message' => '作成しました',
    'data' => $user
], 201);

// エラーレスポンス
return response()->json([
    'error' => 'ユーザーが見つかりません'
], 404);
```

**よく使うHTTPステータスコード**

| コード | 意味 | 使用場面 |
|:---|:---|:---|
| 200 | OK | 成功（デフォルト） |
| 201 | Created | リソース作成成功 |
| 204 | No Content | 成功（返すデータなし） |
| 400 | Bad Request | リクエストが不正 |
| 401 | Unauthorized | 認証が必要 |
| 403 | Forbidden | アクセス権限がない |
| 404 | Not Found | リソースが見つからない |
| 422 | Unprocessable Entity | バリデーションエラー |
| 500 | Internal Server Error | サーバーエラー |

#### 4. リダイレクトする

別のページに転送します。

```php
// 名前付きルートにリダイレクト
return redirect()->route('users.index');

// パラメータ付きでリダイレクト
return redirect()->route('users.show', ['user' => $user->id]);

// URLを直接指定
return redirect('/users');

// 前のページに戻る
return back();

// フラッシュメッセージ付きでリダイレクト
return redirect()->route('users.index')
    ->with('success', 'ユーザーを作成しました');
```

**フラッシュメッセージの表示（Blade）**

```blade
@if (session('success'))
    <div style="color: green;">
        {{ session('success') }}
    </div>
@endif
```

#### 5. ダウンロードさせる

ファイルをダウンロードさせます。

```php
// ファイルをダウンロード
return response()->download($pathToFile);

// ファイル名を指定
return response()->download($pathToFile, 'report.pdf');
```

---

### 🧩 実践例：検索機能の実装

リクエストとレスポンスを使った実践的な例を見てみましょう。

**ルーティング（`routes/web.php`）**

```php
Route::get('/users', [UserController::class, 'index']);
```

**コントローラー（`UserController.php`）**

```php
public function index(Request $request)
{
    // クエリパラメータを取得
    $keyword = $request->query('keyword');
    $sort = $request->query('sort', 'created_at');
    $order = $request->query('order', 'desc');

    // クエリを構築
    $query = User::query();

    // キーワードがあれば検索条件を追加
    if ($request->filled('keyword')) {
        $query->where('name', 'like', "%{$keyword}%")
              ->orWhere('email', 'like', "%{$keyword}%");
    }

    // ソート
    $users = $query->orderBy($sort, $order)->paginate(10);

    // ビューを返す
    return view('users.index', compact('users', 'keyword', 'sort', 'order'));
}
```

**URL例**

```
/users?keyword=山田&sort=name&order=asc
```

---

### 💡 TIP: リクエストの便利なメソッド

| メソッド | 説明 | 例 |
|:---|:---|:---|
| `$request->url()` | クエリパラメータを除いたURL | `/users` |
| `$request->fullUrl()` | クエリパラメータを含むURL | `/users?page=2` |
| `$request->method()` | HTTPメソッド | `GET`, `POST` |
| `$request->isMethod('post')` | メソッドの確認 | `true` / `false` |
| `$request->ip()` | クライアントのIPアドレス | `192.168.1.1` |
| `$request->header('Content-Type')` | ヘッダーの取得 | `application/json` |
| `$request->bearerToken()` | Bearerトークンの取得 | APIの認証トークン |

---

## ✨ まとめ

このセクションでは、Laravelのリクエストとレスポンスの基礎を学びました。

*   **リクエスト**は、ユーザーからサーバーへの要求であり、URL、HTTPメソッド、フォームデータなどの情報を含む。
*   `Request`オブジェクトを使って、`input()`, `query()`, `all()`, `only()`, `except()`などでデータを取得できる。
*   `has()`, `filled()`, `missing()`で値の存在をチェックできる。
*   **レスポンス**は、サーバーからユーザーへの応答であり、ビュー、JSON、リダイレクトなど様々な形式で返せる。
*   `response()->json()`でJSONを返し、`redirect()->route()`でリダイレクトできる。
*   フラッシュメッセージを使って、リダイレクト後にメッセージを表示できる。

これらの知識は、次のセクションで学ぶコントローラーの基礎や、Chapter 6のバリデーションで活用します。

---
