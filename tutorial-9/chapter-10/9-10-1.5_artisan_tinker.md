# Tutorial 9-10-1.5: Artisan Tinker - 対話型デバッグツール

## 🎯 このセクションで学ぶこと

*   Artisan Tinkerが何であるか、その役割を理解する。
*   Tinkerを使って、対話的にEloquentモデルやデータベースを操作できるようになる。
*   デバッグやデータ確認の場面で、Tinkerを活用できるようになる。

---

## 導入：コードを書かずにLaravelを試す

開発中、「このEloquentクエリは正しく動くかな？」「データベースに今どんなデータが入っているかな？」と確認したいことがよくあります。

通常であれば、コントローラーにコードを書いて、ブラウザでアクセスして、結果を確認して...という手順が必要です。しかし、ちょっとした確認のために毎回この手順を踏むのは面倒です。

そこで活躍するのが、**Artisan Tinker**です。Tinkerを使えば、コマンドラインで対話的にLaravelのコードを実行できます。

---

## 詳細解説

### 🛠️ Tinkerとは？

**Tinker（ティンカー）**は、LaravelのREPL（Read-Eval-Print Loop）ツールです。REPLとは、入力したコードを即座に実行し、結果を表示する対話型の環境のことです。

Tinkerを使うと、以下のようなことができます。

*   **Eloquentモデルの操作**: データの取得、作成、更新、削除
*   **データベースの確認**: 現在のデータの状態を確認
*   **ヘルパー関数のテスト**: `now()`, `config()`, `env()`などの動作確認
*   **クラスやメソッドの動作確認**: 新しく書いたコードのテスト

---

### 🚀 Tinkerの起動

Tinkerは、以下のコマンドで起動します。

```bash
docker compose exec php php artisan tinker
```

起動すると、以下のようなプロンプトが表示されます。

```
Psy Shell v0.12.0 (PHP 8.2.0 — cli) by Justin Hileman
>>>
```

`>>>`の後にPHPコードを入力すると、即座に実行されます。

#### Tinkerの終了

Tinkerを終了するには、`exit`と入力するか、`Ctrl + D`を押します。

```php
>>> exit
```

---

### 📝 基本的な使い方

#### 1. Eloquentでデータを取得する

```php
>>> use App\Models\User;
>>> User::all();
```

**実行結果のイメージ**

```
= Illuminate\Database\Eloquent\Collection {#1234
    all: [
      App\Models\User {#5678
        id: 1,
        name: "山田太郎",
        email: "taro@example.com",
        ...
      },
      App\Models\User {#9012
        id: 2,
        name: "鈴木花子",
        email: "hanako@example.com",
        ...
      },
    ],
  }
```

#### 2. 特定のレコードを取得する

```php
>>> User::find(1);
```

**実行結果のイメージ**

```
= App\Models\User {#3456
    id: 1,
    name: "山田太郎",
    email: "taro@example.com",
    email_verified_at: null,
    created_at: "2024-01-15 10:30:00",
    updated_at: "2024-01-15 10:30:00",
  }
```

#### 3. 条件を指定して検索する

```php
>>> User::where('email', 'like', '%example.com')->get();
```

#### 4. レコード数を確認する

```php
>>> User::count();
= 10
```

---

### ✏️ データの作成・更新・削除

Tinkerでは、データの作成・更新・削除も可能です。

#### 新しいレコードを作成する

```php
>>> $user = new User();
>>> $user->name = 'テストユーザー';
>>> $user->email = 'test@example.com';
>>> $user->password = bcrypt('password');
>>> $user->save();
= true
```

または、`create`メソッドを使う方法もあります。

```php
>>> User::create([
...     'name' => 'テストユーザー2',
...     'email' => 'test2@example.com',
...     'password' => bcrypt('password'),
... ]);
```

#### レコードを更新する

```php
>>> $user = User::find(1);
>>> $user->name = '更新された名前';
>>> $user->save();
= true
```

#### レコードを削除する

```php
>>> $user = User::find(1);
>>> $user->delete();
= true
```

> ⚠️ **注意**: Tinkerでの操作は、実際のデータベースに反映されます。本番環境では特に注意してください。

---

### 🔍 デバッグに便利な機能

#### ヘルパー関数のテスト

```php
>>> now();
= Illuminate\Support\Carbon @1705312200 {#1234
    date: 2024-01-15 10:30:00.000000 UTC (+00:00),
  }

>>> config('app.name');
= "Laravel"

>>> env('APP_ENV');
= "local"
```

#### リレーションシップの確認

```php
>>> $user = User::find(1);
>>> $user->posts;  // ユーザーの投稿一覧
>>> $user->posts()->count();  // 投稿数
```

#### SQLクエリの確認

Eloquentが生成するSQLを確認したい場合は、`toSql()`メソッドを使います。

```php
>>> User::where('email', 'like', '%example.com')->toSql();
= "select * from `users` where `email` like ?"
```

バインドされる値も含めて確認したい場合は、`toRawSql()`を使います（Laravel 10.15以降）。

```php
>>> User::where('email', 'like', '%example.com')->toRawSql();
= "select * from `users` where `email` like '%example.com'"
```

---

### 🧩 実践的な使用例

#### 例1: ユーザーのメールアドレスを一括更新

```php
>>> User::where('email', 'like', '%old-domain.com')
...     ->update(['email' => DB::raw("REPLACE(email, 'old-domain.com', 'new-domain.com')")]);
= 5  // 5件更新された
```

#### 例2: 特定の条件のデータを確認

```php
>>> User::whereNull('email_verified_at')->pluck('email');
= Illuminate\Support\Collection {#1234
    all: [
      "unverified1@example.com",
      "unverified2@example.com",
    ],
  }
```

#### 例3: ファクトリーでテストデータを作成

```php
>>> User::factory()->count(5)->create();
```

これで、5人のテストユーザーが作成されます。

#### 例4: 日付の計算

```php
>>> now()->addDays(7);  // 7日後
>>> now()->subMonths(1);  // 1ヶ月前
>>> now()->diffInDays('2024-12-31');  // 年末まであと何日
```

---

### 💡 TIP: Tinkerの便利なショートカット

| ショートカット | 説明 |
|:---|:---|
| `↑` / `↓` | コマンド履歴を移動 |
| `Ctrl + A` | 行の先頭に移動 |
| `Ctrl + E` | 行の末尾に移動 |
| `Ctrl + U` | 行をクリア |
| `Ctrl + L` | 画面をクリア |
| `Ctrl + C` | 現在の入力をキャンセル |
| `Ctrl + D` | Tinkerを終了 |

---

### 🔄 Tinkerの再起動が必要な場面

以下の変更を行った場合、Tinkerを再起動する必要があります。

*   モデルファイルの変更
*   マイグレーションの実行
*   設定ファイルの変更
*   新しいクラスの追加

Tinkerは起動時にクラスを読み込むため、変更を反映するには`exit`で終了し、再度起動する必要があります。

---

## ✨ まとめ

このセクションでは、Artisan Tinkerの使い方を学びました。

*   **Tinker**は、Laravelの対話型REPL環境で、コマンドラインでPHPコードを即座に実行できる。
*   `docker compose exec php php artisan tinker`で起動し、`exit`または`Ctrl + D`で終了する。
*   Eloquentモデルの操作（取得、作成、更新、削除）を対話的に行える。
*   ヘルパー関数のテストや、SQLクエリの確認など、デバッグに非常に便利。
*   Tinkerでの操作は実際のデータベースに反映されるため、本番環境では注意が必要。

Tinkerは、日常的なデバッグやデータ確認で毎日使う必須ツールです。ぜひ積極的に活用してください。

---
