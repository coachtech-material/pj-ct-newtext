# Tutorial 9-4-6.5: キャスト(Casts)とアクセサ・ミューテータ

## 🎯 このセクションで学ぶこと

*   キャスト（Casts）を使って、データベースの値を自動的に変換できるようになる。
*   アクセサを使って、データ取得時にカスタム処理を追加できるようになる。
*   ミューテータを使って、データ保存時にカスタム処理を追加できるようになる。

---

## 導入：データの「入口」と「出口」を制御する

データベースに保存されるデータと、PHPで扱いたいデータの形式が異なることがよくあります。

例えば、以下のような場面を考えてみてください。

*   **JSON形式のデータ**: データベースには文字列として保存されているが、PHPでは配列として扱いたい。
*   **日付データ**: データベースには文字列として保存されているが、PHPではCarbonオブジェクトとして扱いたい。
*   **価格データ**: データベースには税抜き価格が保存されているが、表示時には税込み価格を計算したい。
*   **パスワード**: 保存時に自動的にハッシュ化したい。

Laravelでは、**キャスト（Casts）**、**アクセサ（Accessor）**、**ミューテータ（Mutator）**を使って、これらの変換を自動化できます。

---

## 詳細解説

### 🔄 キャスト（Casts）とは？

**キャスト**は、データベースから値を取得するとき、またはデータベースに値を保存するときに、自動的に型変換を行う機能です。

モデルの`$casts`プロパティで定義します。

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    protected $casts = [
        'email_verified_at' => 'datetime',
        'is_admin' => 'boolean',
        'settings' => 'array',
        'price' => 'decimal:2',
    ];
}
```

---

### 📝 よく使うキャストの種類

| キャスト | 説明 | 使用例 |
|:---|:---|:---|
| `'integer'` | 整数に変換 | `'age' => 'integer'` |
| `'float'` | 浮動小数点数に変換 | `'rating' => 'float'` |
| `'decimal:N'` | 小数点以下N桁の数値に変換 | `'price' => 'decimal:2'` |
| `'string'` | 文字列に変換 | `'code' => 'string'` |
| `'boolean'` | 真偽値に変換 | `'is_active' => 'boolean'` |
| `'array'` | JSON文字列を配列に変換 | `'settings' => 'array'` |
| `'object'` | JSON文字列をオブジェクトに変換 | `'metadata' => 'object'` |
| `'collection'` | JSON文字列をCollectionに変換 | `'tags' => 'collection'` |
| `'datetime'` | Carbonオブジェクトに変換 | `'published_at' => 'datetime'` |
| `'date'` | Carbonオブジェクト（日付のみ）に変換 | `'birthday' => 'date'` |
| `'timestamp'` | Unixタイムスタンプに変換 | `'logged_at' => 'timestamp'` |
| `'encrypted'` | 暗号化して保存、復号して取得 | `'secret' => 'encrypted'` |
| `'hashed'` | ハッシュ化して保存（Laravel 10+） | `'password' => 'hashed'` |

---

### 🧩 キャストの実践例

#### 例1: JSON配列のキャスト

ユーザーの設定情報をJSON形式で保存する場合を考えます。

**マイグレーション**

```php
$table->json('settings')->nullable();
```

**モデル**

```php
protected $casts = [
    'settings' => 'array',
];
```

**使用例**

```php
// 保存時：配列を自動的にJSONに変換
$user->settings = [
    'theme' => 'dark',
    'notifications' => true,
    'language' => 'ja',
];
$user->save();

// 取得時：JSONを自動的に配列に変換
$theme = $user->settings['theme']; // 'dark'
```

データベースには以下のように保存されます。

```json
{"theme":"dark","notifications":true,"language":"ja"}
```

#### 例2: 真偽値のキャスト

データベースでは`0`/`1`で保存されている値を、PHPでは`true`/`false`として扱いたい場合。

**モデル**

```php
protected $casts = [
    'is_published' => 'boolean',
];
```

**使用例**

```php
// 保存時
$post->is_published = true;  // データベースには 1 が保存される
$post->save();

// 取得時
if ($post->is_published) {   // true として評価される
    echo '公開中';
}
```

#### 例3: 日付のキャスト

```php
protected $casts = [
    'published_at' => 'datetime',
    'birthday' => 'date',
];
```

**使用例**

```php
// Carbonオブジェクトとして取得される
$post->published_at->format('Y年m月d日'); // '2024年01月15日'
$post->published_at->diffForHumans();     // '3日前'

// 日付の比較も簡単
if ($post->published_at->isPast()) {
    echo '公開済み';
}
```

#### 例4: 暗号化キャスト

機密情報を暗号化して保存したい場合。

```php
protected $casts = [
    'api_key' => 'encrypted',
];
```

**使用例**

```php
// 保存時：自動的に暗号化
$user->api_key = 'sk-1234567890abcdef';
$user->save();

// 取得時：自動的に復号
echo $user->api_key; // 'sk-1234567890abcdef'
```

データベースには暗号化された文字列が保存されます。

---

### 🔍 アクセサ（Accessor）とは？

**アクセサ**は、モデルの属性を取得するときに、カスタム処理を追加する機能です。データベースに存在しない「仮想的な属性」を作成することもできます。

Laravel 9以降では、`Illuminate\Database\Eloquent\Casts\Attribute`クラスを使って定義します。

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * フルネームを取得するアクセサ
     */
    protected function fullName(): Attribute
    {
        return Attribute::make(
            get: fn () => $this->first_name . ' ' . $this->last_name,
        );
    }
}
```

**使用例**

```php
$user = User::find(1);
echo $user->full_name; // '山田 太郎'
```

**コードリーディング**

*   `protected function fullName(): Attribute`: メソッド名はキャメルケースで定義しますが、アクセス時はスネークケース（`full_name`）で使用します。
*   `get: fn () => ...`: データを取得するときの処理を定義します。

---

### ✏️ ミューテータ（Mutator）とは？

**ミューテータ**は、モデルの属性を設定するときに、カスタム処理を追加する機能です。

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * 名前を設定するときに、先頭を大文字にする
     */
    protected function firstName(): Attribute
    {
        return Attribute::make(
            get: fn (string $value) => ucfirst($value),
            set: fn (string $value) => strtolower($value),
        );
    }
}
```

**使用例**

```php
$user = new User();
$user->first_name = 'TARO';  // 保存時: 'taro' に変換
$user->save();

echo $user->first_name;       // 取得時: 'Taro' に変換
```

**コードリーディング**

*   `set: fn (string $value) => ...`: データを設定するときの処理を定義します。

---

### 🧩 アクセサ・ミューテータの実践例

#### 例1: 税込み価格の計算

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Model;

class Product extends Model
{
    /**
     * 税込み価格を取得するアクセサ
     */
    protected function priceWithTax(): Attribute
    {
        return Attribute::make(
            get: fn () => (int) round($this->price * 1.1),
        );
    }
}
```

**使用例**

```php
$product = Product::find(1);
echo $product->price;          // 1000（税抜き）
echo $product->price_with_tax; // 1100（税込み）
```

#### 例2: パスワードの自動ハッシュ化

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    /**
     * パスワードを設定するときに自動的にハッシュ化
     */
    protected function password(): Attribute
    {
        return Attribute::make(
            set: fn (string $value) => bcrypt($value),
        );
    }
}
```

**使用例**

```php
$user = new User();
$user->password = 'plain_password';  // 自動的にハッシュ化される
$user->save();
```

> 💡 **TIP**: Laravel 10以降では、`'password' => 'hashed'`キャストを使うことで、同じ効果を得られます。

#### 例3: 仮想属性の定義

データベースに存在しない属性を定義することもできます。

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    /**
     * 年齢を計算するアクセサ
     */
    protected function age(): Attribute
    {
        return Attribute::make(
            get: fn () => $this->birthday?->age,
        );
    }

    protected $casts = [
        'birthday' => 'date',
    ];
}
```

**使用例**

```php
$user = User::find(1);
echo $user->age; // 25（誕生日から自動計算）
```

---

### 📊 キャスト vs アクセサ・ミューテータの使い分け

| 機能 | キャスト | アクセサ・ミューテータ |
|:---|:---|:---|
| **用途** | 型変換（JSON↔配列、文字列↔日付など） | カスタムロジック（計算、フォーマットなど） |
| **定義方法** | `$casts`プロパティ | メソッドで定義 |
| **複雑さ** | シンプル | 柔軟だが複雑 |
| **仮想属性** | 不可 | 可能 |
| **推奨** | 単純な型変換に使用 | 複雑なロジックに使用 |

---

### 🔄 `$appends`で仮想属性をJSONに含める

アクセサで定義した仮想属性は、デフォルトではJSONシリアライズ時に含まれません。含めたい場合は、`$appends`プロパティを使います。

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Model;

class Product extends Model
{
    protected $appends = ['price_with_tax'];

    protected function priceWithTax(): Attribute
    {
        return Attribute::make(
            get: fn () => (int) round($this->price * 1.1),
        );
    }
}
```

**使用例**

```php
$product = Product::find(1);
return response()->json($product);

// 出力:
// {
//     "id": 1,
//     "name": "商品A",
//     "price": 1000,
//     "price_with_tax": 1100,  // 仮想属性も含まれる
//     ...
// }
```

---

## 💡 TIP: カスタムキャストクラス

より複雑なキャストロジックが必要な場合は、カスタムキャストクラスを作成できます。

```bash
docker compose exec php php artisan make:cast Json
```

```php
<?php

namespace App\Casts;

use Illuminate\Contracts\Database\Eloquent\CastsAttributes;

class Json implements CastsAttributes
{
    public function get($model, string $key, $value, array $attributes)
    {
        return json_decode($value, true);
    }

    public function set($model, string $key, $value, array $attributes)
    {
        return json_encode($value, JSON_UNESCAPED_UNICODE);
    }
}
```

**使用例**

```php
protected $casts = [
    'settings' => \App\Casts\Json::class,
];
```

---

## ✨ まとめ

このセクションでは、キャスト、アクセサ、ミューテータの使い方を学びました。

*   **キャスト**は、`$casts`プロパティで定義し、データベースの値を自動的に型変換する（JSON↔配列、文字列↔日付など）。
*   **アクセサ**は、データ取得時にカスタム処理を追加する（税込み価格の計算、フルネームの生成など）。
*   **ミューテータ**は、データ保存時にカスタム処理を追加する（パスワードのハッシュ化、文字列の正規化など）。
*   単純な型変換にはキャスト、複雑なロジックにはアクセサ・ミューテータを使い分ける。
*   `$appends`プロパティで、仮想属性をJSONシリアライズに含めることができる。

これらの機能を活用することで、データの「入口」と「出口」を適切に制御し、クリーンなコードを書くことができます。

---
