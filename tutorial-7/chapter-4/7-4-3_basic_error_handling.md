# Tutorial 7-4-3: エラーハンドリングの基礎

## 🎯 このセクションで学ぶこと

*   PHPにおける、エラーの種類（Notice, Warning, Fatal Error）を、区別できるようになる。
*   `try...catch`ブロックを使った、例外処理の、基本的な書き方を、理解する。
*   なぜ、エラーハンドリングが、重要なのかを、説明できるようになる。
*   意図的に、例外を発生させる（`throw`）方法を、学ぶ。

---

## 導入

プログラミングにおいて、エラーは、避けて通れません。どんなに、注意深く、コードを書いても、予期せぬ、入力があったり、外部の、サービスが、停止していたり、様々な原因で、エラーは発生します。

重要なのは、エラーが発生したときに、**アプリケーションが、完全に、停止してしまう（クラッシュする）のを、防ぎ、可能な限り、適切に、処理を続ける**ことです。また、開発者にとっては、エラーの原因を、特定しやすくするための、情報を、記録することも、重要です。

このような、エラー発生時の、処理の流れを、制御することを、**エラーハンドリング**と呼びます。このセクションでは、PHPにおける、エラーハンドリングの、基本的な考え方と、その、実装方法である、**例外処理**について、学んでいきます。

---

## 詳細解説

### 🚨 PHPのエラーレベル

PHPには、いくつかの、エラーレベルがありますが、代表的な、3つを、理解しておきましょう。

1.  **Notice（通知）**: 最も、軽微なエラー。「未定義の変数を使おうとした」など、実行は継続できるが、コードに、問題がある可能性を、示唆します。
2.  **Warning（警告）**: Noticeより、重要度が高いエラー。「存在しないファイルを、読み込もうとした」など、処理は継続できますが、期待通りの、結果には、ならない可能性が、高いです。
3.  **Fatal Error（致命的なエラー）**: 最も、重大なエラー。「存在しない関数を呼び出した」など、このエラーが発生すると、スクリプトの実行は、即座に、停止します。

開発中は、これらのエラーを、全て、表示するように、設定し、エラーの芽を、一つずつ、摘んでいくことが、重要です。（`php.ini`の`display_errors`や`error_reporting`で設定します）

### 🛡️ 例外処理: `try...catch`

WarningやFatal Errorは、発生すると、プログラムの、正常な流れを、中断させてしまいます。しかし、エラーが発生する可能性のある処理を、あらかじめ、予測し、「もし、エラーが起きたら、こちらの処理を実行してね」と、指示しておくことができます。これが、**例外処理（Exception Handling）**です。

PHPでは、`try...catch`ブロックを使って、例外処理を、実装します。

```php
// 例: 0で割り算をすると、エラーが発生する
$divisor = 0;

try {
    // エラーが発生する可能性のある処理を、tryブロックで囲む
    if ($divisor === 0) {
        // 意図的に、例外を「投げる」（throw）
        throw new Exception("0で割ることはできません。");
    }

    $result = 10 / $divisor;
    echo "計算結果: " . $result;

} catch (Exception $e) {
    // 例外が「キャッチ」された場合の処理
    echo "エラーが発生しました: " . $e->getMessage();
}

echo "<br>プログラムの処理は、ここで続行されます。";
```

#### `try` ブロック

*   例外が、発生する可能性のある、コードを、このブロックで、囲みます。
*   `try`ブロック内で、例外が発生すると、その時点で、処理は中断され、即座に、`catch`ブロックに、処理が移ります。

#### `throw` 文

*   `throw new Exception("エラーメッセージ");` のように、記述し、意図的に、例外を、発生させることができます。
*   PHPの、組み込み関数の中には、エラーが発生すると、自動的に、例外を、`throw`するものもあります（例: `PDO`を使ったデータベース操作など）。
*   `Exception`は、PHPに、組み込まれている、基本的な、例外クラスです。

#### `catch` ブロック

*   `throw`された、例外を、「キャッチ」して、補足処理を、行うブロックです。
*   `catch (Exception $e)` の `$e` には、`Exception`オブジェクトが、格納されます。
*   `$e->getMessage()`: `throw`されたときに、指定した、エラーメッセージを、取得できます。
*   `$e->getFile()`: 例外が発生した、ファイル名を取得できます。
*   `$e->getLine()`: 例外が発生した、行番号を取得できます。

`try...catch`を使う、最大のメリットは、**エラーが発生しても、プログラム全体が、停止するのを、防げる**ことです。上記の例では、`catch`ブロックの処理が終わった後、最後の`echo`文が、正常に実行されていることが、わかります。

### 📂 ファイル操作と例外処理

前のセクションで学んだ、ファイル操作は、例外処理と、組み合わせるのに、最適な例です。

```php
function readFileContent(string $filename): string
{
    if (!file_exists($filename)) {
        throw new Exception("ファイル '{$filename}' が見つかりません。");
    }

    if (!is_readable($filename)) {
        throw new Exception("ファイル '{$filename}' は読み込み可能ではありません。");
    }

    $content = file_get_contents($filename);

    if ($content === false) {
        throw new Exception("ファイル '{$filename}' の読み込みに失敗しました。");
    }

    return $content;
}

try {
    $content = readFileContent("non_existent_file.txt");
    echo $content;
} catch (Exception $e) {
    // エラーログに記録するなどの処理
    error_log($e->getMessage());

    // ユーザーには、分かりやすいメッセージを表示する
    echo "エラーが発生したため、処理を中断しました。管理者に連絡してください。";
}
```

この例では、`readFileContent`関数の中で、いくつかの、エラー条件を、チェックし、問題があれば、例外を`throw`しています。呼び出し側は、`try...catch`で、それを、補足し、ユーザーには、詳細なエラー内容を見せず、裏側で、`error_log`関数を使って、エラーログに、記録しています。

このように、**ユーザーに見せる情報と、開発者が見る情報を、分ける**ことが、良い、エラーハンドリングの、基本です。

---

## ✨ まとめ

このセクションでは、PHPにおける、エラーハンドリングの、基礎について学びました。

*   **PHPのエラーレベル**: `Notice`, `Warning`, `Fatal Error` の3つを、理解する。
*   **例外処理**: `try...catch`ブロックを使い、エラーが発生しても、プログラムが、停止しないようにする。
*   **`try`**: エラーが、発生しうる、コードを囲む。
*   **`throw`**: 意図的に、例外を、発生させる。
*   **`catch`**: `throw`された、例外を、補足し、代替処理を行う。
*   **`Exception`オブジェクト**: `$e->getMessage()`などで、エラーの詳細情報を、取得できる。
*   **良いエラーハンドリング**: ユーザーには、シンプルなメッセージを、開発者には、詳細なログを、残すように、処理を分けることが重要。

エラーハンドリングは、地味ですが、アプリケーションの、**堅牢性（ロバストネス）**を高める上で、非常に、重要なスキルです。エラーから、目を背けず、積極的に、向き合っていく姿勢が、良い、エンジニアへの、第一歩です。

---

## 📝 学習のポイント

- [ ] PHPの、3つの、主要な、エラーレベルを、説明できる。
- [ ] `try...catch`ブロックの、役割と、基本的な、書き方を、説明できる。
- [ ] `throw`を使って、自分で、例外を、発生させることができる。
- [ ] なぜ、エラーハンドリングが、アプリケーションの、堅牢性にとって、重要なのかを、説明できる。
- [ ] ユーザーに見せる、エラーメッセージと、開発者向けの、エラーログを、分離する、という考え方を、理解した。
