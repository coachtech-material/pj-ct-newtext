# Tutorial 13-3-1: API認証の仕組み（概念理解）

## 🎯 このセクションで学ぶこと

- API認証（トークンベース認証）の仕組みを理解する
- Web認証（セッションベース認証）との違いを深く理解する
- Laravel Sanctumの概要を知る

> **📌 このセクションについて**
> 
> このセクションでは、API認証の**概念**を学びます。実装は行いません。
> 
> 実際のAPI認証の実装は、より高度なカリキュラムで扱います。

---

## 🧠 先輩エンジニアの思考プロセス

### 「なぜAPI認証を理解する必要があるのか？」

Tutorial 10-12で学んだ**Web認証（Fortify）**と、API開発で使う**API認証**は、仕組みが大きく異なります。

バックエンドエンジニアとして、両方の認証方式を**概念レベルで理解**しておくことは重要です。

---

## Step 1: Web認証とAPI認証の復習

### 1-1. 認証方式の比較（図解）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Web認証（Cookie/Session）                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ブラウザ                        サーバー                        │
│  ┌─────┐                        ┌─────────┐                    │
│  │     │  ①ログイン（ID/PW）    │         │                    │
│  │     │ ─────────────────────> │         │                    │
│  │     │                        │ Session │                    │
│  │     │  ②Set-Cookie          │  作成   │                    │
│  │     │ <───────────────────── │  保存   │                    │
│  │     │                        │         │                    │
│  │     │  ③リクエスト（Cookie自動送信）   │                    │
│  │     │ ─────────────────────> │ Session │                    │
│  │     │                        │  照合   │                    │
│  └─────┘                        └─────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    API認証（Token）                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  クライアント                    サーバー                        │
│  ┌─────┐                        ┌─────────┐                    │
│  │     │  ①ログイン（ID/PW）    │         │                    │
│  │     │ ─────────────────────> │         │                    │
│  │     │                        │ Token   │                    │
│  │     │  ②Token発行            │  発行   │                    │
│  │     │ <───────────────────── │         │                    │
│  │ Token│                        │         │                    │
│  │ 保存 │  ③リクエスト           │         │                    │
│  │     │  Authorization: Bearer xxx       │                    │
│  │     │ ─────────────────────> │ Token   │                    │
│  │     │                        │  検証   │                    │
│  └─────┘                        └─────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1-2. 詳細比較

| 項目 | Web認証（Cookie/Session） | API認証（Token） |
|:---|:---|:---|
| **状態管理** | ステートフル | ステートレス |
| **認証情報の保存場所** | サーバー（Session） | クライアント（Token） |
| **認証情報の送信方法** | Cookie（自動送信） | Authorizationヘッダー（手動） |
| **CSRF対策** | 必要 | 不要 |
| **スケーラビリティ** | 低い（Session共有が必要） | 高い（サーバー間で状態共有不要） |
| **主な用途** | Webブラウザ | スマホアプリ、外部システム |
| **Laravel** | Fortify | Sanctum |

---

## Step 2: トークンベース認証の仕組み

### 2-1. トークンとは

**トークン**とは、ユーザーを識別するための**一意の文字列**です。

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### 2-2. トークン認証のフロー

```
1. クライアントがログインAPIにID/PWを送信
2. サーバーがID/PWを検証し、正しければトークンを発行
3. クライアントはトークンを保存（ローカルストレージなど）
4. 以降のリクエストでは、Authorizationヘッダーにトークンを付与
5. サーバーはトークンを検証し、ユーザーを特定
```

### 2-3. Authorizationヘッダー

APIリクエストでは、トークンを**Authorizationヘッダー**に付与します。

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

| 項目 | 説明 |
|:---|:---|
| `Authorization` | ヘッダー名 |
| `Bearer` | 認証スキーム（トークン認証を示す） |
| `eyJhbGci...` | トークン本体 |

---

## Step 3: Laravel Sanctumの概要

### 3-1. Sanctumとは

**Laravel Sanctum**は、LaravelでAPI認証を実装するためのパッケージです。

| 特徴 | 説明 |
|:---|:---|
| シンプル | 簡単に実装できる |
| 軽量 | 必要最小限の機能 |
| 2つの認証方式 | APIトークン認証とSPA認証 |

### 3-2. Sanctumの2つの認証方式

| 方式 | 用途 | 説明 |
|:---|:---|:---|
| APIトークン認証 | スマホアプリ、外部システム | トークンをAuthorizationヘッダーに付与 |
| SPA認証 | 同一ドメインのSPA | Cookie/Sessionを使用（Fortifyと似た仕組み） |

### 3-3. Sanctumの仕組み（概念図）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Sanctum APIトークン認証                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  スマホアプリ                    Laravel                         │
│  ┌─────┐                        ┌─────────┐                    │
│  │     │  POST /api/login       │         │                    │
│  │     │  {email, password}     │         │                    │
│  │     │ ─────────────────────> │ Sanctum │                    │
│  │     │                        │         │                    │
│  │     │  {token: "abc123..."}  │ Token   │                    │
│  │     │ <───────────────────── │ 発行    │                    │
│  │     │                        │         │                    │
│  │     │  GET /api/tasks        │         │                    │
│  │     │  Authorization: Bearer abc123... │                    │
│  │     │ ─────────────────────> │ Token   │                    │
│  │     │                        │ 検証    │                    │
│  │     │  {data: [...]}         │         │                    │
│  │     │ <───────────────────── │         │                    │
│  └─────┘                        └─────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step 4: 認証方式の選択基準

### 4-1. どちらを使うべきか

| 状況 | 推奨される認証方式 |
|:---|:---|
| Webブラウザからのアクセス | Web認証（Fortify） |
| スマホアプリからのアクセス | API認証（Sanctum） |
| 外部システムとの連携 | API認証（Sanctum） |
| 同一ドメインのSPA | SPA認証（Sanctum） |

### 4-2. 実際の開発では

多くのWebサービスでは、**両方の認証方式を併用**します。

```
┌─────────────────────────────────────────────────────────────────┐
│                    実際のWebサービス                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐                                                   │
│  │ ブラウザ │ ──── Web認証（Fortify）────> ┌─────────┐         │
│  └─────────┘                              │         │         │
│                                           │ Laravel │         │
│  ┌─────────┐                              │         │         │
│  │スマホアプリ│ ── API認証（Sanctum）───> │         │         │
│  └─────────┘                              └─────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 💡 TIP: JWTとの違い

**JWT（JSON Web Token）**は、トークン自体に情報を含む形式です。

| 項目 | Sanctum | JWT |
|:---|:---|:---|
| トークンの形式 | ランダム文字列 | 署名付きJSON |
| 情報の格納 | データベースに保存 | トークン自体に含む |
| 無効化 | データベースから削除 | 有効期限まで無効化困難 |
| 複雑さ | シンプル | やや複雑 |

Sanctumは、シンプルさを重視した設計になっています。

---

## ✨ まとめ

このセクションでは、API認証の仕組みを概念レベルで学びました。

| Step | 学んだこと |
|:---|:---|
| Step 1 | Web認証とAPI認証の違い（図解） |
| Step 2 | トークンベース認証の仕組み |
| Step 3 | Laravel Sanctumの概要 |
| Step 4 | 認証方式の選択基準 |

> **📌 重要なポイント**
> 
> - **Web認証**：ブラウザ向け、Cookie/Session、ステートフル
> - **API認証**：アプリ向け、Token、ステートレス
> - 実際の開発では、要件に応じて適切な認証方式を選択する
> 
> このカリキュラムでは、API認証の**実装**は扱いません。概念を理解した上で、必要に応じて公式ドキュメントを参照してください。

次のセクションでは、APIのセキュリティについて学びます。

---
