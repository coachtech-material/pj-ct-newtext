# Tutorial 13-1-2: データベース設計

## 🎯 このセクションで学ぶこと

- 書籍レビューアプリのデータベース設計を行う方法を学ぶ
- ER図を作成し、テーブル設計を行う
- データベース設計の重要性と、実務での活用方法を理解する

---

## 🧠 先輩エンジニアの思考プロセス

### 「なぜ要件定義の次にデータベース設計なのか？」

要件定義で「何を作るか」が決まったら、次は「どうやってデータを保存するか」を決めます。

### 理由1: データ構造が決まらないとコードが書けない

```
❌ データ構造を決めずにコードを書く
→ 「このデータはどこに保存する？」と迷う
→ 後からテーブル構造を変更する羽目になる

✅ 先にデータ構造を決める
→ マイグレーション、モデル、コントローラーの設計がスムーズ
→ 一貫性のあるコードが書ける
```

### 理由2: リレーションシップを先に決める

「ユーザーと書籍の関係は？」を先に決めておくと、Eloquentのリレーションシップ設計が楽になります。

### 理由3: 画面設計の前提になる

「どんなデータを表示するか」は「どんなデータがあるか」に依存します。データベース設計が先です。

---

### このセクションの実装順序

| 順番 | 作業 | 理由 |
|:---:|:---|:---|
| 1 | エンティティの抽出 | 何を管理するかを決める |
| 2 | リレーションシップの定義 | エンティティ間の関係を決める |
| 3 | ER図の作成 | 視覚的に確認する |
| 4 | テーブル設計 | カラムとデータ型を決める |

---

## 導入：なぜデータベース設計が必要なのか

**データベース設計（Database Design）**とは、**システムで扱うデータの構造を設計する作業**です。

データベース設計を行わずに開発を始めると、以下のような問題が発生します。

- **データの重複**: 同じデータが複数のテーブルに保存される
- **データの不整合**: データが矛盾する（例: ユーザーが削除されたのに、そのユーザーのレビューが残っている）
- **パフォーマンスの低下**: データの取得に時間がかかる

データベース設計を行うことで、これらの問題を防ぐことができます。

---

## Step 1: データベース設計の流れ

データベース設計は、以下の3つのステップで行います。

1. **エンティティの抽出**: システムで扱うデータ（エンティティ）を洗い出す
2. **リレーションシップの定義**: エンティティ間の関係を定義する
3. **テーブル設計**: エンティティをテーブルに落とし込む

---

## Step 2: エンティティの抽出

**エンティティ（Entity）**とは、**システムで扱うデータのまとまり**です。

書籍レビューアプリでは、以下のようなエンティティがあります。

- **ユーザー（User）**: システムを利用するユーザー
- **書籍（Book）**: 登録された書籍とレビュー情報

> 💡 **ポイント**: このチュートリアルでは、シンプルな構成にするため、書籍とレビューを1つのテーブルで管理します。

---

## Step 3: リレーションシップの定義

**リレーションシップ（Relationship）**とは、**エンティティ間の関係**です。

書籍レビューアプリでは、以下のようなリレーションシップがあります。

- **ユーザーと書籍**: 1対多（1人のユーザーは複数の書籍レビューを持つ）

---

## Step 4: ER図の作成

**ER図（Entity-Relationship Diagram）**とは、**エンティティとリレーションシップを図で表したもの**です。

ER図を作成することで、**データベースの構造を視覚的に理解できる**ようになります。

---

#### ER図

```
[users]
  id (PK)
  name
  email
  password
  created_at
  updated_at
  |
  | 1対多
  |
[books]
  id (PK)
  user_id (FK)
  title
  author
  rating
  review
  created_at
  updated_at
```

### ER図のコードリーディング

| 記号 | 意味 |
|:---|:---|
| `[users]` | usersテーブル |
| `id (PK)` | 主キー（Primary Key） |
| `user_id (FK)` | 外部キー（Foreign Key） |
| `1対多` | 1つのusersレコードに対して、複数のbooksレコードが紐づく |

---

## Step 5: テーブル設計

ER図を作成したら、**テーブル設計**を行います。

テーブル設計では、以下の内容を決めます。

- **テーブル名**: エンティティ名を複数形にする（例: users、books）
- **カラム名**: データの項目名
- **データ型**: データの型（例: INT、VARCHAR、TEXT、DATETIME）
- **制約**: データの制約（例: NOT NULL、UNIQUE、PRIMARY KEY、FOREIGN KEY）

---

#### usersテーブル

| カラム名 | データ型 | 制約 | 説明 |
|:---|:---|:---|:---|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ユーザーID |
| name | VARCHAR(255) | NOT NULL | ユーザー名 |
| email | VARCHAR(255) | NOT NULL, UNIQUE | メールアドレス |
| password | VARCHAR(255) | NOT NULL | パスワード（ハッシュ化） |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

---

#### booksテーブル

| カラム名 | データ型 | 制約 | 説明 |
|:---|:---|:---|:---|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 書籍ID |
| user_id | BIGINT | NOT NULL, FOREIGN KEY | ユーザーID |
| title | VARCHAR(255) | NOT NULL | 書籍タイトル |
| author | VARCHAR(255) | NOT NULL | 著者名 |
| rating | TINYINT | NOT NULL | 評価（1〜5） |
| review | TEXT | NULL | 感想・レビュー |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

### テーブル設計のコードリーディング

| 項目 | 説明 |
|:---|:---|
| `BIGINT` | 大きな整数。IDに使用 |
| `VARCHAR(255)` | 最大255文字の可変長文字列 |
| `TINYINT` | 小さな整数（-128〜127）。評価1〜5に最適 |
| `TEXT` | 長い文字列。レビュー本文に使用 |
| `PRIMARY KEY` | 主キー。テーブル内で一意 |
| `AUTO_INCREMENT` | 自動採番 |
| `NOT NULL` | NULL禁止 |
| `UNIQUE` | 重複禁止 |
| `FOREIGN KEY` | 外部キー。別テーブルの主キーを参照 |

---

### 💡 TIP: 外部キー制約

**外部キー制約（Foreign Key Constraint）**とは、**別のテーブルの主キーを参照する制約**です。

外部キー制約を設定することで、**データの整合性を保つ**ことができます。

**例**: booksテーブルのuser_idは、usersテーブルのidを参照します。

- ユーザーが削除されたら、そのユーザーの書籍レビューも削除される（CASCADE）
- 存在しないユーザーIDを持つ書籍は作成できない

---

## Step 6: 正規化

**正規化（Normalization）**とは、**データの重複を排除し、データの整合性を保つための手法**です。

今回の設計では、ユーザー情報と書籍情報を別テーブルに分けることで、正規化を行っています。

**正規化のメリット**:
- ユーザー名が変更されても、書籍テーブルを更新する必要がない
- データの重複が排除され、ストレージを節約できる

---

### 💡 TIP: データベース設計ツール

データベース設計には、以下のようなツールが便利です。

- **draw.io**: 無料のオンライン図作成ツール
- **MySQL Workbench**: MySQLの公式GUIツール
- **dbdiagram.io**: ER図を簡単に作成できるオンラインツール

---

### 🚨 よくある間違い

#### 間違い1: 外部キー制約を設定しない

**対処法**: 外部キー制約を設定することで、データの整合性を保つことができます。必ず設定しましょう。

---

#### 間違い2: データ型を適切に選ばない

**対処法**: データ型を適切に選ぶことで、ストレージを節約し、パフォーマンスを向上させることができます。

- **INT / BIGINT**: 整数（例: ID）
- **TINYINT**: 小さな整数（例: 評価1〜5）
- **VARCHAR**: 可変長文字列（例: 名前、メールアドレス）
- **TEXT**: 長い文字列（例: レビュー本文）
- **TIMESTAMP**: 日時（例: 作成日時）

---

## ✨ まとめ

このセクションでは、書籍レビューアプリのデータベース設計について学びました。

- データベース設計は、エンティティの抽出、リレーションシップの定義、テーブル設計の3つのステップで行う
- ER図を作成することで、データベースの構造を視覚的に理解できる
- 外部キー制約を設定することで、データの整合性を保つことができる

次のセクションでは、画面設計について学びます。

---
