# Tutorial 13-1-6: CORSとは

## 🎯 このセクションで学ぶこと

- CORSとは何かを理解する
- なぜCORSが必要なのかを学ぶ
- LaravelでCORSを設定する方法を学ぶ
- CORSエラーの対処法を理解する

---

## 🧠 先輩エンジニアの思考プロセス

### 「なぜAPIルートの後に『CORS』を学ぶのか？」

APIルートを定義したら、次は「CORS」です。

---

### 理由1: フロントエンドからのアクセス

フロントエンドとバックエンドが**別のドメイン**で動いている場合、CORSの設定が必要です。

| 役割 | URL |
|------|-----|
| フロントエンド | http://localhost:3000 |
| バックエンド | http://localhost:8000 |

---

### 理由2: セキュリティの仕組み

ブラウザは、**異なるオリジンへのリクエストを制限**しています。

これは「同一オリジンポリシー」というセキュリティ機能です。

CORSを設定することで、**許可されたオリジンからのアクセス**を受け入れます。

---

### 理由3: 本番環境でも必要

開発環境だけでなく、**本番環境でもCORSの設定**が必要です。

適切に設定しないと、フロントエンドからAPIにアクセスできません。

---

### このセクションでやること

| 順番 | 作業 | 理由 |
|------|------|------|
| Step 1 | CORSの概念を理解 | なぜ必要なのかを学ぶ |
| Step 2 | LaravelのCORS設定 | `config/cors.php`の編集 |
| Step 3 | CORSエラーの対処 | トラブルシューティング |

> 💡 **ポイント**: CORSは「Cross-Origin Resource Sharing」の略で、異なるオリジン間でのリソース共有を制御します。

---

## Step 1: CORSの基本概念

### 1-1. CORSとは

**CORS（Cross-Origin Resource Sharing）**は、**異なるオリジン間でのリソース共有を制御する仕組み**です。

**オリジン**とは、**プロトコル + ドメイン + ポート**の組み合わせです。

| オリジンの例 |
|-------------|
| http://localhost:8000 |
| http://localhost:3000 |
| https://example.com |

---

### 1-2. 同一オリジンポリシー

ブラウザには、**同一オリジンポリシー**というセキュリティ機能があります。

| 状況 | 結果 |
|------|------|
| http://localhost:3000 → http://localhost:8000 | 異なるオリジン（ブロック） |
| http://localhost:8000 → http://localhost:8000 | 同一オリジン（許可） |

---

### 1-3. CORSの仕組み

ブラウザは、異なるオリジンへのリクエストを送信する前に、**プリフライトリクエスト**を送信します。

| 項目 | 説明 |
|------|------|
| HTTPメソッド | OPTIONS |
| 目的 | サーバーがCORSを許可しているか確認 |

サーバーが許可している場合、ブラウザは本来のリクエストを送信します。

---

### 1-4. CORSエラーの例

```
Access to fetch at 'http://localhost:8000/api/tasks' from origin 'http://localhost:3000' has been blocked by CORS policy
```

---

## Step 2: LaravelでのCORS設定

### 2-1. 設定ファイル

**ファイル**: `config/cors.php`

```php
<?php

return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],

    'allowed_methods' => ['*'],

    'allowed_origins' => ['*'],

    'allowed_origins_patterns' => [],

    'allowed_headers' => ['*'],

    'exposed_headers' => [],

    'max_age' => 0,

    'supports_credentials' => false,
];
```

---

### 2-2. 設定項目の説明

| 項目 | 説明 |
|------|------|
| paths | CORSを適用するパス |
| allowed_methods | 許可するHTTPメソッド |
| allowed_origins | 許可するオリジン |
| allowed_headers | 許可するヘッダー |
| max_age | プリフライトのキャッシュ時間 |

---

### 2-3. 開発環境でのCORS設定

開発環境では、**すべてのオリジンを許可**します。

```php
'allowed_origins' => ['*'],
```

---

### 2-4. 本番環境でのCORS設定

本番環境では、**特定のオリジンだけを許可**します。

```php
'allowed_origins' => [
    'https://example.com',
    'https://www.example.com',
],
```

---

### 2-5. 環境変数を使った設定

**ファイル**: `.env`

```
FRONTEND_URL=http://localhost:3000
```

**ファイル**: `config/cors.php`

```php
'allowed_origins' => [
    env('FRONTEND_URL', 'http://localhost:3000'),
],
```

---

## Step 3: CORSエラーの対処法

### 3-1. 設定を確認する

```php
// config/cors.php
'allowed_origins' => ['*'],
```

---

### 3-2. キャッシュをクリアする

```bash
sail artisan config:clear
sail artisan cache:clear
```

---

### 3-3. CORSとCSRFの違い

| 項目 | CORS | CSRF |
|------|------|------|
| 目的 | 異なるオリジンからのリクエストを制御 | 偽造リクエストを防ぐ |
| 適用 | API | Webページ |
| ヘッダー | Access-Control-Allow-Origin | X-CSRF-TOKEN |

---

## 🚨 よくある間違い

### 間違い1: 本番環境でallowed_originsを['*']にする

**問題**: セキュリティリスクがある

```php
// ❌ 間違い（本番環境）
'allowed_origins' => ['*'],

// ✅ 正しい（本番環境）
'allowed_origins' => [
    'https://example.com',
],
```

---

### 間違い2: CORSエラーをサーバー側のエラーと勘違いする

**問題**: CORSエラーは**ブラウザ側のエラー**

**対処法**: サーバー側でCORS設定を行います。

---

### 間違い3: CORSとCSRFを混同する

**問題**: 異なるセキュリティ機能

| 機能 | 目的 |
|------|------|
| CORS | 異なるオリジンからのリクエストを制御 |
| CSRF | 偽造リクエストを防ぐ |

---

## 💡 TIP: プリフライトリクエストをキャッシュする

プリフライトリクエストをキャッシュすると、パフォーマンスが向上します。

```php
'max_age' => 86400, // 24時間
```

---

## ✨ まとめ

このセクションでは、CORSについて学びました。

| Step | 学んだこと |
|------|-----------|
| Step 1 | CORSの基本概念と同一オリジンポリシー |
| Step 2 | LaravelでのCORS設定方法 |
| Step 3 | CORSエラーの対処法 |

これで、Chapter 1（API開発の基礎）は完了です。次のChapter 2では、RESTful APIの実装について学びます。

---
