
# Tutorial 8-3-4: JOIN句によるテーブルの結合 - 分割したデータをつなぎ合わせる

## 🎯 このセクションで学ぶこと

*   なぜテーブルを結合する必要があるのか、その動機を理解する。
*   `INNER JOIN`を使って、2つのテーブルを内部結合し、関連するデータを一度に取得できるようになる。
*   `ON`句が、テーブル結合における「接着剤」の役割を果たすことを理解する。
*   `LEFT JOIN`（外部結合）の概念を理解し、`INNER JOIN`との違いを説明できるようになる。
*   3つ以上のテーブルを`JOIN`して、多対多の関係から複雑な情報を引き出せるようになる。

---

## 導入：バラバラの名簿を、一つのリストに

これまでのセクションで、私たちはデータの重複や不整合を防ぐために、情報を「ユーザー」「投稿」「タグ」といった関心事ごとにテーブルへ分割してきました。これは非常に正しいアプローチです。しかし、その結果、新たな課題が生まれます。

例えば、「投稿の一覧ページを作りたい。投稿のタイトルと一緒に、**投稿者の名前**も表示したい」と考えたとします。`posts`テーブルを見てみましょう。

| id | user_id | title | content |
|:---|:---|:---|:---|
| 101 | 1 | 今日は良い天気！ | ... |
| 102 | 1 | 昼食はパスタ。 | ... |
| 103 | 2 | プログラミング楽しい！ | ... |

`posts`テーブルには投稿者の名前（`name`）は含まれておらず、誰が書いたかを示す`user_id`しかありません。投稿者の名前は`users`テーブルにあります。

| id | name | email |
|:---|:---|:---|
| 1 | John Doe | john@example.com |
| 2 | Jane Smith | jane@example.com |

これでは、投稿一覧を表示するために、まず`posts`テーブルから全件データを取得し、次に一件一件の`user_id`を使って`users`テーブルに問い合わせる...といった面倒な処理が必要になってしまいます。アプリケーション側で何度もデータベースに問い合わせるのは非常に非効率です。

この問題を一発で解決するのが、リレーショナルデータベースの真骨頂ともいえる**`JOIN`**句です。`JOIN`は、分割された複数のテーブルを、リレーションシップ（主キーと外部キーの関連）を頼りに、あたかも一つの大きなテーブルであるかのように、仮想的に「結合」してデータを取得する機能です。

---

## 詳細解説

### 🤝 基本の結合：`INNER JOIN`

最もよく使われる`JOIN`が`INNER JOIN`（内部結合）です。これは、指定した2つのテーブルの両方に、結合条件に一致するレコードが存在する場合にのみ、データを結合します。

基本的な構文は以下の通りです。

```sql
SELECT カラムリスト
FROM テーブル1
INNER JOIN テーブル2 ON テーブル1.カラム = テーブル2.カラム;
```

*   `FROM テーブル1`: 主軸となるテーブルを指定します。
*   `INNER JOIN テーブル2`: 結合したい相手のテーブルを指定します。
*   `ON テーブル1.カラム = テーブル2.カラム`: **ここが最重要**です。2つのテーブルをどのカラムで関連付けるのか、結合の「条件（接着剤）」を指定します。通常は、主キーと外部キーのペア（例: `users.id = posts.user_id`）を指定します。

#### 具体例：ユーザー名と投稿タイトルを結合する

`users`テーブルと`posts`テーブルを結合して、「誰が」「何というタイトルの投稿をしたか」を取得してみましょう。

```sql
SELECT
    users.name,  -- usersテーブルのnameカラム
    posts.title  -- postsテーブルのtitleカラム
FROM
    users
INNER JOIN
    posts ON users.id = posts.user_id;
```

**[ここに、上記SQLの実行結果として、ユーザー名と投稿タイトルが並んだ表形式のスクリーンショットを挿入]**

このSQLを実行すると、データベース内部では以下のことが行われます。

1.  `users`テーブルと`posts`テーブルを`ON`句の条件（`users.id = posts.user_id`）で紐付けようと試みる。
2.  `posts`テーブルの各レコードについて、その`user_id`と同じ値を持つ`id`を`users`テーブルから探す。
3.  条件に一致するペアが見つかったレコードだけを結合し、`SELECT`句で指定されたカラム（`users.name`と`posts.title`）を抽出して結果を返す。

#### テーブルのエイリアス（別名）

`テーブル名.カラム名`という書き方は、どのテーブルのカラムかを明示するために重要ですが、長くなるとSQL文が読みにくくなります。そこで、`AS`を使ってテーブルに短い別名（エイリアス）を付けるのが一般的です（`AS`は省略可能）。

```sql
SELECT
    u.name,
    p.title
FROM
    users AS u
INNER JOIN
    posts AS p ON u.id = p.user_id;
```
`users AS u`とすることで、以降このクエリ内では`users`を`u`という名前で参照できます。格段にスッキリしましたね。

### 🚪 片方のデータは全部見たい：`LEFT JOIN`

`INNER JOIN`は、両方のテーブルに関連が見つかったレコードだけを返しました。では、「**まだ一度も投稿していないユーザーも含めて**、全ユーザーの一覧が見たい」場合はどうでしょう？ `INNER JOIN`では、投稿（`posts`）が存在しないユーザーは結果に含まれません。

このようなケースで使うのが`LEFT JOIN`（左外部結合）です。

```sql
SELECT
    u.name,
    p.title
FROM
    users AS u  -- こちらが「左」のテーブル
LEFT JOIN
    posts AS p ON u.id = p.user_id;
```

`LEFT JOIN`は、`FROM`句で指定した**左側のテーブル（この場合は`users`）の全レコードを基準**にします。そして、`ON`句の条件に一致するレコードが右側のテーブル（`posts`）にあれば、そのデータを結合します。もし一致するレコードがなくても、左側のテーブルの情報は結果に含まれ、右側のテーブルに対応するカラムは`NULL`として表示されます。

**[ここに、上記SQLの実行結果のスクリーンショットを挿入。投稿していないユーザーの`title`が`NULL`になっていることを示す]**

| name | title |
|:---|:---|
| John Doe | 今日は良い天気！ |
| John Doe | 昼食はパスタ。 |
| Jane Smith | プログラミング楽しい！ |
| Bob Johnson | NULL |

このように、`LEFT JOIN`を使うと、「〜を持っている/持っていない」にかかわらず、基準となる側の全データを取得できます。

### 엮 3つ以上のテーブルを結合する（多対多）

`JOIN`は2つだけでなく、3つ、4つと数珠つなぎにすることができます。これにより、多対多の関係からも複雑な情報を引き出せます。

例：「どの投稿に」「どのタグが」「誰によって」付けられたかを知りたい。

これには`posts`, `post_tag`, `tags`, `users`の4つのテーブルを結合する必要があります。

```sql
SELECT
    p.title AS post_title,  -- カラム名にもエイリアスを付けられる
    t.name AS tag_name,
    u.name AS user_name
FROM
    posts AS p
INNER JOIN
    post_tag AS pt ON p.id = pt.post_id
INNER JOIN
    tags AS t ON pt.tag_id = t.id
INNER JOIN
    users AS u ON p.user_id = u.id;
```

**[ここに、上記SQLの実行結果のスクリーンショットを挿入。投稿タイトル、タグ名、ユーザー名が一覧になっている]**

このクエリは、以下のように連鎖的にテーブルを結合していきます。

1.  `posts`と`post_tag`を`post_id`で結合。
2.  さらにその結果を`tags`と`tag_id`で結合。
3.  さらにその結果を`users`と`user_id`で結合。

このように`JOIN`を繋げていくことで、正規化によって分割されたテーブルから、必要な情報を自在に組み合わせて取得できるのです。これこそがリレーショナルデータベースのパワーです。

---

## ✨ まとめ

このセクションでは、分割したテーブルを仮想的に結合する`JOIN`句について学びました。

*   `JOIN`は、複数のテーブルに分割されたデータを、リレーションを元に一つの結果として取得するための強力な機能。
*   `INNER JOIN`は、両方のテーブルに結合条件が一致するレコードが存在する場合にのみデータを返す。
*   `LEFT JOIN`は、左側のテーブルの全レコードを基準とし、右側に一致するデータがなくても`NULL`として結果を返す。
*   `ON`句で、どのカラムをキーとしてテーブル同士を結合するかを指定する。
*   `AS`を使ってテーブルやカラムにエイリアス（別名）を付けると、SQL文が簡潔で読みやすくなる。
*   `JOIN`は数珠つなぎにすることで、3つ以上のテーブルを結合し、複雑なデータを取り出すことができる。

`JOIN`を使いこなせることは、データベースを扱う上で必須のスキルです。LaravelのEloquent ORMは、この`JOIN`を裏側で自動的に、かつ効率的に実行してくれますが、その仕組みをSQLレベルで理解しているかどうかで、パフォーマンスチューニングや複雑なクエリへの対応力に大きな差が出ます。

次のチャプターでは、`WHERE`句や集計関数など、取得するデータをさらに絞り込んだり、集計したりするための、より実践的なSQLについて学んでいきます。

---
