# Tutorial 11-6-5: テストカバレッジの確認

## 🎯 このセクションで学ぶこと

*   テストカバレッジとは何かを理解する。
*   テストカバレッジを確認する方法を学ぶ。
*   テストの網羅性を高める方法を学ぶ。
*   テストのベストプラクティスを理解する。

---

## 導入：なぜテストカバレッジが重要なのか

**テストカバレッジ**は、**コードのどれだけがテストされているか**を示す指標です。

テストカバレッジを確認することで、**テストされていない箇所を見つけ、テストの網羅性を高める**ことができます。

---

## 詳細解説

### 🔍 テストカバレッジとは

**テストカバレッジ**は、以下の指標で表されます。

*   **行カバレッジ**: 実行された行の割合
*   **関数カバレッジ**: 実行された関数の割合
*   **分岐カバレッジ**: 実行された分岐の割合

---

### 🔍 テストカバレッジを確認する

テストカバレッジを確認するには、以下のコマンドを実行します。

```bash
./vendor/bin/phpunit --coverage-html coverage
```

`coverage/index.html`をブラウザで開くと、テストカバレッジが表示されます。

---

### 🔍 Xdebugのインストール

テストカバレッジを確認するには、**Xdebug**が必要です。

```bash
# Xdebugをインストール
sudo apt-get install php-xdebug

# Xdebugが有効になっているか確認
php -v
```

---

### 🔍 テストカバレッジの見方

テストカバレッジのレポートを開くと、以下の情報が表示されます。

*   **緑色**: テストされている行
*   **赤色**: テストされていない行
*   **黄色**: 一部の分岐がテストされていない行

---

### 🔍 テストされていない箇所を見つける

テストカバレッジのレポートを見て、**赤色の行**を見つけます。

その行をテストするテストケースを追加します。

---

### 🔍 実践演習: テストカバレッジを確認してください

以下の手順で、テストカバレッジを確認してください。

1.  テストを実行する
2.  テストカバレッジのレポートを開く
3.  テストされていない箇所を見つける
4.  テストケースを追加する

---

### 🔍 テストカバレッジの目標

**テストカバレッジの目標**は、プロジェクトによって異なりますが、一般的には以下の通りです。

*   **80%以上**: 良好
*   **90%以上**: 優秀
*   **100%**: 理想的（ただし、現実的には難しい）

---

### 🔍 テストカバレッジだけでは不十分

**テストカバレッジが高い**からといって、**テストの質が高い**とは限りません。

*   **正常系だけでなく、異常系もテストする**
*   **エッジケースもテストする**
*   **テストの意図を明確にする**

---

### 🔍 テストのベストプラクティス

以下のベストプラクティスに従います。

*   **テストは独立している**: 他のテストに依存しない
*   **テストは高速である**: 数秒以内に実行できる
*   **テストは読みやすい**: 何をテストしているか分かりやすい
*   **テストは保守しやすい**: コードが変わっても、テストを修正しやすい

---

### 🔍 テストの命名規則

テストの命名規則は、以下の通りです。

```php
public function test_何をテストするか()
{
    // ...
}
```

**例**:

*   `test_ログインしたユーザーがタスクを作成できる()`
*   `test_タイトルが空の場合タスクを作成できない()`
*   `test_他人のタスクを更新できない()`

---

### 🔍 テストの整理

テストが増えてきたら、以下のように整理します。

*   **ファイルごとに分ける**: `TaskTest.php`、`UserTest.php`
*   **メソッドごとに分ける**: `test_create()`、`test_update()`、`test_delete()`
*   **正常系と異常系を分ける**: `test_正常系()`、`test_異常系()`

---

### 🔍 テストの実行を高速化する

テストの実行を高速化するには、以下の方法があります。

*   **並列実行を使う**: `php artisan test --parallel`
*   **メモリ上のデータベースを使う**: `DB_DATABASE=:memory:`
*   **不要なテストをスキップする**: `$this->markTestSkipped()`

---

### 🔍 CI/CDでテストを自動化する

**CI/CD**を使うと、コミットやプルリクエストのたびに、自動的にテストが実行されます。

**GitHub Actions**の例:

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1
      - name: Install Dependencies
        run: composer install
      - name: Run Tests
        run: php artisan test
```

---

### 🔍 実践演習: テストを追加してください

以下のテストを追加して、テストカバレッジを高めてください。

**テスト内容**:
*   優先度が5を超える場合、タスクを作成できないことを確認する

---

**解答例**:

```php
public function test_優先度が5を超える場合タスクを作成できない()
{
    // 準備
    $user = User::factory()->create();
    
    // 実行
    $response = $this->actingAs($user)->post('/tasks', [
        'title' => 'テストタスク',
        'description' => 'テスト説明',
        'status' => 'pending',
        'priority' => 6,
    ]);
    
    // 検証
    $response->assertStatus(302);
    $response->assertSessionHasErrors('priority');
    $this->assertDatabaseMissing('tasks', [
        'title' => 'テストタスク',
    ]);
}
```

---

### 🔍 テストのリファクタリング

テストもリファクタリングします。

*   **重複コードを削除する**: `setUp()`メソッドを使う
*   **ヘルパーメソッドを作る**: `createTask()`、`createUser()`
*   **データプロバイダーを使う**: 複数のパターンをテストする

---

### 💡 TIP: Pest PHPを使う

**Pest PHP**は、PHPUnitの代替テストフレームワークです。

より簡潔にテストを書けます。

```php
it('can create a task', function () {
    $user = User::factory()->create();
    
    $response = $this->actingAs($user)->post('/tasks', [
        'title' => 'Test Task',
        'description' => 'Test Description',
        'status' => 'pending',
        'priority' => 3,
    ]);
    
    $response->assertStatus(302);
    expect(Task::count())->toBe(1);
});
```

---

### 🚨 よくある間違い

#### 間違い1: テストカバレッジだけを追求する

テストカバレッジが100%でも、テストの質が低ければ意味がありません。

**対処法**: 正常系だけでなく、異常系もテストします。

---

#### 間違い2: テストを書かない

「時間がない」という理由で、テストを書かないのは危険です。

**対処法**: 最初から少しずつテストを書きます。

---

#### 間違い3: テストが遅い

テストが遅いと、開発効率が下がります。

**対処法**: 並列実行やメモリ上のデータベースを使います。

---

## ✨ まとめ

このセクションでは、テストカバレッジの確認を学びました。

*   テストカバレッジとは何かを理解した。
*   テストカバレッジを確認する方法を学んだ。
*   テストの網羅性を高める方法を学んだ。
*   テストのベストプラクティスを理解した。

これで、Tutorial 11（Laravel実践講座）は完了です。お疲れさまでした！

---

## 📝 学習のポイント

- [ ] テストカバレッジを確認した。
- [ ] テストされていない箇所を見つけた。
- [ ] テストケースを追加した。
- [ ] テストのベストプラクティスを理解した。

---

## 🎉 Tutorial 11の完了

Tutorial 11（Laravel実践講座）を完了しました！

このチュートリアルでは、以下のことを学びました。

*   **Chapter 1**: 要件定義とデータベース設計
*   **Chapter 2**: CRUD機能の実装
*   **Chapter 3**: 認証とリレーションシップ
*   **Chapter 4**: セキュリティ対策
*   **Chapter 5**: リファクタリング
*   **Chapter 6**: テスト

次のTutorial 12では、API開発について学びます。
