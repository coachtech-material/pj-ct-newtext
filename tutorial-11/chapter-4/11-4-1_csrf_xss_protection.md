# Tutorial 11-4-1: CSRF保護とXSS対策

## 🎯 このセクションで学ぶこと

*   CSRF（Cross-Site Request Forgery）攻撃とその対策を学ぶ。
*   XSS（Cross-Site Scripting）攻撃とその対策を学ぶ。
*   Laravelが提供するセキュリティ機能を理解する。

---

## 導入：なぜセキュリティが重要なのか

**セキュリティ**は、Webアプリケーション開発において非常に重要です。

セキュリティ対策を怠ると、以下のような被害が発生する可能性があります。

*   **個人情報の漏洩**: ユーザーの名前、メールアドレス、パスワードなどが盗まれる
*   **データの改ざん**: タスクやユーザー情報が不正に変更される
*   **サービスの停止**: 攻撃によってシステムが停止する

このセクションでは、**CSRF攻撃**と**XSS攻撃**について学び、Laravelが提供するセキュリティ機能を理解します。

---

## 詳細解説

### 🔍 CSRF攻撃とは

**CSRF（Cross-Site Request Forgery）攻撃**とは、**ユーザーの意図しないリクエストを送信させる攻撃**です。

---

#### CSRF攻撃の例

1. ユーザーがタスク管理システムにログインしている
2. 攻撃者が作成した悪意のあるWebサイトにアクセスする
3. そのWebサイトには、以下のようなHTMLが埋め込まれている

```html
<form action="http://task-app.com/tasks/1" method="POST">
    <input type="hidden" name="_method" value="DELETE">
</form>
<script>
    document.forms[0].submit();
</script>
```

4. ユーザーが気づかないうちに、タスクが削除される

---

### 🔍 Laravelのcsrf保護

Laravelは、**CSRFトークン**を使って、CSRF攻撃を防ぎます。

**CSRFトークン**とは、**フォームに埋め込まれるランダムな文字列**です。

Laravelは、フォームが送信されたときに、CSRFトークンが正しいかどうかを確認します。

---

#### CSRFトークンの使い方

Bladeテンプレートで、`@csrf`ディレクティブを使います。

```blade
<form method="POST" action="{{ route('tasks.store') }}">
    @csrf
    <!-- フォームの内容 -->
</form>
```

これにより、以下のようなHTMLが生成されます。

```html
<form method="POST" action="http://task-app.com/tasks">
    <input type="hidden" name="_token" value="ランダムな文字列">
    <!-- フォームの内容 -->
</form>
```

---

### 💡 TIP: CSRFトークンの仕組み

1. ユーザーがページにアクセスすると、LaravelはCSRFトークンを生成し、セッションに保存する
2. フォームに`@csrf`を追加すると、CSRFトークンが隠しフィールドとして埋め込まれる
3. フォームが送信されると、Laravelはセッションに保存されたCSRFトークンと、フォームから送信されたCSRFトークンを比較する
4. 一致すれば、リクエストを処理する。一致しなければ、エラーを返す

---

### 🚨 CSRFトークンを忘れた場合

`@csrf`を忘れると、以下のようなエラーが発生します。

```
419 | Page Expired
```

これは、CSRFトークンが一致しないため、Laravelがリクエストを拒否したことを意味します。

---

### 🔍 XSS攻撃とは

**XSS（Cross-Site Scripting）攻撃**とは、**Webページに悪意のあるスクリプトを埋め込む攻撃**です。

---

#### XSS攻撃の例

1. 攻撃者が、タスクのタイトルに以下のような文字列を入力する

```html
<script>alert('XSS攻撃！');</script>
```

2. タスク一覧ページで、このタスクが表示される
3. ブラウザがスクリプトを実行し、アラートが表示される

---

### 🔍 LaravelのXSS対策

Laravelは、**自動エスケープ**を使って、XSS攻撃を防ぎます。

**エスケープ**とは、**HTMLタグを無効化すること**です。

---

#### 自動エスケープの使い方

Bladeテンプレートで、`{{ }}`を使います。

```blade
<p>{{ $task->title }}</p>
```

これにより、以下のようなHTMLが生成されます。

```html
<p>&lt;script&gt;alert('XSS攻撃！');&lt;/script&gt;</p>
```

`<`が`&lt;`に、`>`が`&gt;`に変換され、スクリプトが実行されなくなります。

---

### 💡 TIP: エスケープしない場合

エスケープせずにHTMLを表示したい場合は、`{!! !!}`を使います。

```blade
<p>{!! $task->title !!}</p>
```

ただし、**ユーザーが入力したデータには絶対に使わない**でください。XSS攻撃の危険性があります。

---

### 🔍 実践: XSS攻撃を試してみよう

#### ステップ1: タスクを作成する

タスクのタイトルに、以下のような文字列を入力します。

```html
<script>alert('XSS攻撃！');</script>
```

---

#### ステップ2: タスク一覧を確認する

タスク一覧ページで、タスクが表示されます。

**Bladeで`{{ }}`を使っている場合**:

```html
<p>&lt;script&gt;alert('XSS攻撃！');&lt;/script&gt;</p>
```

スクリプトは実行されず、文字列として表示されます。

---

**Bladeで`{!! !!}`を使っている場合**:

```html
<p><script>alert('XSS攻撃！');</script></p>
```

スクリプトが実行され、アラートが表示されます。

---

### 🔍 その他のセキュリティ対策

#### SQLインジェクション対策

**SQLインジェクション**とは、**SQLクエリに悪意のあるコードを埋め込む攻撃**です。

Laravelの**Eloquent ORM**や**クエリビルダー**を使うことで、SQLインジェクション攻撃を防ぐことができます。

**悪い例**（生のSQLクエリ）:

```php
$email = $_GET['email'];
$user = DB::select("SELECT * FROM users WHERE email = '$email'");
```

攻撃者が`email`に`' OR '1'='1`を入力すると、以下のようなSQLクエリが実行されます。

```sql
SELECT * FROM users WHERE email = '' OR '1'='1'
```

これにより、全てのユーザー情報が取得されてしまいます。

---

**良い例**（Eloquent ORM）:

```php
$email = request('email');
$user = User::where('email', $email)->first();
```

Eloquentは、自動的にパラメータをエスケープするため、SQLインジェクション攻撃を防ぐことができます。

---

#### パスワードのハッシュ化

パスワードは、**必ずハッシュ化**して保存します。

```php
$user = User::create([
    'name' => $request->name,
    'email' => $request->email,
    'password' => Hash::make($request->password), // ハッシュ化
]);
```

ハッシュ化することで、データベースが漏洩しても、パスワードが盗まれることを防ぎます。

---

#### HTTPSの使用

**HTTPS**を使うことで、通信内容を暗号化し、盗聴や改ざんを防ぐことができます。

実務では、必ずHTTPSを使用します。

---

### 💡 TIP: Laravelのセキュリティ機能

Laravelは、以下のようなセキュリティ機能を提供しています。

*   **CSRF保護**: `@csrf`ディレクティブ
*   **XSS対策**: `{{ }}`による自動エスケープ
*   **SQLインジェクション対策**: Eloquent ORMとクエリビルダー
*   **パスワードのハッシュ化**: `Hash::make()`
*   **認証機能**: Laravel Sanctum、Laravel Breeze
*   **認可機能**: ポリシーとゲート

---

### 🚨 よくある間違い

#### 間違い1: CSRFトークンを忘れる

**対処法**: フォームに`@csrf`を追加します。

---

#### 間違い2: ユーザー入力をエスケープせずに表示する

**対処法**: `{{ }}`を使って、自動エスケープを有効にします。

---

#### 間違い3: パスワードを平文で保存する

**対処法**: `Hash::make()`を使って、パスワードをハッシュ化します。

---

### 🔍 実務でのセキュリティ対策

実務では、以下のようなセキュリティ対策を行います。

*   **定期的なセキュリティアップデート**: Laravelやパッケージを最新版に保つ
*   **セキュリティ監査**: 定期的にセキュリティ診断を行う
*   **ログの監視**: 不正なアクセスを検知する
*   **バックアップ**: データの損失に備える
*   **アクセス制限**: 管理画面へのアクセスをIP制限する

---

## ✨ まとめ

このセクションでは、CSRF攻撃とXSS攻撃について学びました。

*   CSRF攻撃は、ユーザーの意図しないリクエストを送信させる攻撃である。
*   Laravelは、CSRFトークンを使って、CSRF攻撃を防ぐ。
*   XSS攻撃は、Webページに悪意のあるスクリプトを埋め込む攻撃である。
*   Laravelは、自動エスケープを使って、XSS攻撃を防ぐ。
*   セキュリティ対策は、Webアプリケーション開発において非常に重要である。

次のセクションでは、リファクタリングについて学びます。

---

## 📝 学習のポイント

- [ ] CSRF（Cross-Site Request Forgery）攻撃とその対策を学んだ。
- [ ] XSS（Cross-Site Scripting）攻撃とその対策を学んだ。
- [ ] Laravelが提供するセキュリティ機能を理解した。
