# Tutorial 11-4-3: XSS対策

## 🎯 このセクションで学ぶこと

*   XSS（クロスサイトスクリプティング）とは何かを理解し、その危険性を学ぶ。
*   Bladeテンプレートを使って、XSSを防ぐ方法を学ぶ。
*   HTMLを表示する場合の安全な方法を学ぶ。

---

## 導入：なぜXSS対策が重要なのか

**XSS（Cross-Site Scripting）**は、**悪意のあるスクリプトを注入して、ユーザーのブラウザで実行させる攻撃**です。

XSS対策を行わないと、Cookie情報が盗まれたり、ユーザーが意図しない操作を実行させられたりする可能性があります。

---

## 詳細解説

### 🔍 XSSの例

以下のコードは、**XSSの脆弱性**があります。

```blade
<!-- ❌ 危険なコード -->
<p>タイトル: {!! $task->title !!}</p>
```

ユーザーが`title`に`<script>alert('XSS')</script>`を入力すると、以下のHTMLが出力されます。

```html
<p>タイトル: <script>alert('XSS')</script></p>
```

これにより、**スクリプトが実行**されてしまいます。

---

### 🔍 Bladeテンプレートを使った安全な実装

Bladeテンプレートの`{{ }}`を使うと、自動的にエスケープされます。

```blade
<!-- ✅ 安全なコード -->
<p>タイトル: {{ $task->title }}</p>
```

ユーザーが`title`に`<script>alert('XSS')</script>`を入力すると、以下のHTMLが出力されます。

```html
<p>タイトル: &lt;script&gt;alert('XSS')&lt;/script&gt;</p>
```

これにより、**スクリプトは実行されず、文字列として表示**されます。

---

### 🔍 エスケープとは

**エスケープ**は、**特殊文字をHTMLエンティティに変換する処理**です。

*   `<` → `&lt;`
*   `>` → `&gt;`
*   `&` → `&amp;`
*   `"` → `&quot;`
*   `'` → `&#039;`

---

### 🔍 HTMLを表示する場合

HTMLを表示する場合は、`{!! !!}`を使います。

```blade
<!-- HTMLを表示する場合 -->
<p>{!! $task->description !!}</p>
```

ただし、**ユーザーの入力をそのまま表示するのは危険**です。

---

### 🔍 HTMLPurifierを使った安全な実装

**HTMLPurifier**は、**安全なHTMLのみを許可するライブラリ**です。

```bash
composer require mews/purifier
```

**ファイル**: `app/Http/Controllers/TaskController.php`

```php
use Mews\Purifier\Facades\Purifier;

public function store(Request $request)
{
    $validated = $request->validate([
        'title' => 'required|max:255',
        'description' => 'nullable',
        // ...
    ]);

    $validated['description'] = Purifier::clean($validated['description']);
    $validated['user_id'] = auth()->id();

    Task::create($validated);

    return redirect()->route('tasks.index')->with('success', 'タスクを作成しました。');
}
```

---

### 🔍 Markdownを使う

Markdownを使うと、安全にHTMLを生成できます。

```bash
composer require league/commonmark
```

**ファイル**: `app/Http/Controllers/TaskController.php`

```php
use League\CommonMark\CommonMarkConverter;

public function show(Task $task)
{
    $converter = new CommonMarkConverter();
    $task->description_html = $converter->convert($task->description);

    return view('tasks.show', compact('task'));
}
```

**ファイル**: `resources/views/tasks/show.blade.php`

```blade
<tr>
    <th>説明</th>
    <td>{!! $task->description_html !!}</td>
</tr>
```

---

### 🔍 e()ヘルパー関数

`e()`ヘルパー関数を使うと、手動でエスケープできます。

```php
$escaped = e($task->title);
```

---

### 🔍 JavaScript内での出力

JavaScript内で変数を出力する場合は、`@json`ディレクティブを使います。

```blade
<script>
    var task = @json($task);
    console.log(task.title);
</script>
```

---

### 💡 TIP: Content Security Policy (CSP)

**Content Security Policy (CSP)**は、**XSS攻撃を防ぐHTTPヘッダー**です。

```php
// ミドルウェアでCSPヘッダーを設定
return response($content)
    ->header('Content-Security-Policy', "default-src 'self'");
```

---

### 🚨 よくある間違い

#### 間違い1: {!! !!}を使ってユーザー入力を表示する

**対処法**: {{ }}を使います。

---

#### 間違い2: JavaScriptで直接変数を出力する

**対処法**: @jsonディレクティブを使います。

---

#### 間違い3: HTMLPurifierを使わずにHTMLを表示する

**対処法**: HTMLPurifierまたはMarkdownを使います。

---

## ✨ まとめ

このセクションでは、XSS対策を学びました。

*   XSSの危険性を理解した。
*   Bladeテンプレートの{{ }}を使って、自動的にエスケープした。
*   HTMLを表示する場合は、HTMLPurifierまたはMarkdownを使った。

次のセクションでは、認証とセッション管理について学びます。

---

## 📝 学習のポイント

- [ ] XSSの危険性を理解した。
- [ ] {{ }}を使った安全な実装を学んだ。
- [ ] エスケープの仕組みを理解した。
- [ ] HTMLPurifierまたはMarkdownを使った。
