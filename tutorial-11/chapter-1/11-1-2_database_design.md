# Tutorial 11-1-2: データベース設計

## 🎯 このセクションで学ぶこと

*   タスク管理システムのデータベース設計を行う方法を学ぶ。
*   ER図を作成し、テーブル設計を行う。
*   データベース設計の重要性と、実務での活用方法を理解する。

---

## 導入：なぜデータベース設計が必要なのか

**データベース設計（Database Design）**とは、**システムで扱うデータの構造を設計する作業**です。

データベース設計を行わずに開発を始めると、以下のような問題が発生します。

*   **データの重複**: 同じデータが複数のテーブルに保存される
*   **データの不整合**: データが矛盾する（例: ユーザーが削除されたのに、そのユーザーのタスクが残っている）
*   **パフォーマンスの低下**: データの取得に時間がかかる

データベース設計を行うことで、これらの問題を防ぐことができます。

---

## 詳細解説

## Step 1: データベース設計の流れ

データベース設計は、以下の3つのステップで行います。

1. **エンティティの抽出**: システムで扱うデータ（エンティティ）を洗い出す
2. **リレーションシップの定義**: エンティティ間の関係を定義する
3. **テーブル設計**: エンティティをテーブルに落とし込む

---

## Step 2: エンティティの抽出

**エンティティ（Entity）**とは、**システムで扱うデータのまとまり**です。

タスク管理システムでは、以下のようなエンティティがあります。

*   **ユーザー（User）**: システムを利用するユーザー
*   **タスク（Task）**: やるべきこと
*   **カテゴリー（Category）**: タスクの分類
*   **タグ（Tag）**: タスクに付けるラベル

---

## Step 3: リレーションシップの定義

**リレーションシップ（Relationship）**とは、**エンティティ間の関係**です。

タスク管理システムでは、以下のようなリレーションシップがあります。

*   **ユーザーとタスク**: 1対多（1人のユーザーは複数のタスクを持つ）
*   **タスクとカテゴリー**: 多対1（複数のタスクは1つのカテゴリーに属する）
*   **タスクとタグ**: 多対多（1つのタスクは複数のタグを持ち、1つのタグは複数のタスクに付けられる）

---

## Step 4: ER図の作成

**ER図（Entity-Relationship Diagram）**とは、**エンティティとリレーションシップを図で表したもの**です。

ER図を作成することで、**データベースの構造を視覚的に理解できる**ようになります。

---

#### ER図の例

```
[User]
  id (PK)
  name
  email
  password
  created_at
  updated_at
  |
  | 1対多
  |
[Task]
  id (PK)
  user_id (FK)
  category_id (FK)
  title
  description
  status
  due_date
  created_at
  updated_at
  |
  | 多対多
  |
[task_tag]（中間テーブル）
  task_id (FK)
  tag_id (FK)
  |
  |
[Tag]
  id (PK)
  name
  created_at
  updated_at

[Category]
  id (PK)
  name
  created_at
  updated_at
```

---

## Step 5: テーブル設計

ER図を作成したら、**テーブル設計**を行います。

テーブル設計では、以下の内容を決めます。

*   **テーブル名**: エンティティ名を複数形にする（例: users、tasks）
*   **カラム名**: データの項目名
*   **データ型**: データの型（例: INT、VARCHAR、TEXT、DATETIME）
*   **制約**: データの制約（例: NOT NULL、UNIQUE、PRIMARY KEY、FOREIGN KEY）

---

#### usersテーブル

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ユーザーID |
| name | VARCHAR(255) | NOT NULL | ユーザー名 |
| email | VARCHAR(255) | NOT NULL, UNIQUE | メールアドレス |
| password | VARCHAR(255) | NOT NULL | パスワード（ハッシュ化） |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

---

#### tasksテーブル

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | タスクID |
| user_id | BIGINT | NOT NULL, FOREIGN KEY | ユーザーID |
| category_id | BIGINT | NULL, FOREIGN KEY | カテゴリーID |
| title | VARCHAR(255) | NOT NULL | タスクのタイトル |
| description | TEXT | NULL | タスクの説明 |
| status | ENUM('pending', 'in_progress', 'completed') | NOT NULL, DEFAULT 'pending' | タスクの状態 |
| due_date | DATE | NULL | 期限 |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

---

#### categoriesテーブル

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | カテゴリーID |
| name | VARCHAR(255) | NOT NULL, UNIQUE | カテゴリー名 |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

---

#### tagsテーブル

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | タグID |
| name | VARCHAR(255) | NOT NULL, UNIQUE | タグ名 |
| created_at | TIMESTAMP | NULL | 作成日時 |
| updated_at | TIMESTAMP | NULL | 更新日時 |

---

#### task_tagテーブル（中間テーブル）

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| task_id | BIGINT | NOT NULL, FOREIGN KEY | タスクID |
| tag_id | BIGINT | NOT NULL, FOREIGN KEY | タグID |

**複合主キー**: (task_id, tag_id)

---

### 💡 TIP: 外部キー制約

**外部キー制約（Foreign Key Constraint）**とは、**別のテーブルの主キーを参照する制約**です。

外部キー制約を設定することで、**データの整合性を保つ**ことができます。

**例**: tasksテーブルのuser_idは、usersテーブルのidを参照します。

*   ユーザーが削除されたら、そのユーザーのタスクも削除される（CASCADE）
*   存在しないユーザーIDを持つタスクは作成できない

---

## Step 6: 正規化

**正規化（Normalization）**とは、**データの重複を排除し、データの整合性を保つための手法**です。

正規化には、以下の段階があります。

*   **第1正規形（1NF）**: 繰り返し項目を排除する
*   **第2正規形（2NF）**: 部分関数従属を排除する
*   **第3正規形（3NF）**: 推移的関数従属を排除する

---

#### 正規化の例

**正規化前**:

| user_id | user_name | task_title | task_description |
|---------|-----------|------------|------------------|
| 1 | 太郎 | 買い物 | 牛乳を買う |
| 1 | 太郎 | 掃除 | 部屋を掃除する |
| 2 | 花子 | 勉強 | 英語を勉強する |

この表では、user_nameが重複しています。

---

**正規化後**:

**usersテーブル**:

| user_id | user_name |
|---------|-----------|
| 1 | 太郎 |
| 2 | 花子 |

**tasksテーブル**:

| task_id | user_id | task_title | task_description |
|---------|---------|------------|------------------|
| 1 | 1 | 買い物 | 牛乳を買う |
| 2 | 1 | 掃除 | 部屋を掃除する |
| 3 | 2 | 勉強 | 英語を勉強する |

正規化することで、user_nameの重複が排除されました。

---

## Step 7: ER図を作成しよう

### エンティティを抽出する

ブログシステムを開発する場合、以下のようなエンティティがあります。

*   **ユーザー（User）**
*   **記事（Post）**
*   **コメント（Comment）**
*   **カテゴリー（Category）**

---

### リレーションシップを定義する

*   **ユーザーと記事**: 1対多（1人のユーザーは複数の記事を投稿する）
*   **記事とコメント**: 1対多（1つの記事は複数のコメントを持つ）
*   **記事とカテゴリー**: 多対1（複数の記事は1つのカテゴリーに属する）

---

### ER図を作成する

```
[User]
  id (PK)
  name
  email
  password
  created_at
  updated_at
  |
  | 1対多
  |
[Post]
  id (PK)
  user_id (FK)
  category_id (FK)
  title
  content
  created_at
  updated_at
  |
  | 1対多
  |
[Comment]
  id (PK)
  post_id (FK)
  user_id (FK)
  content
  created_at
  updated_at

[Category]
  id (PK)
  name
  created_at
  updated_at
```

---

### 💡 TIP: データベース設計ツール

データベース設計には、以下のようなツールが便利です。

*   **draw.io**: 無料のオンライン図作成ツール
*   **MySQL Workbench**: MySQLの公式GUIツール
*   **dbdiagram.io**: ER図を簡単に作成できるオンラインツール

---

### 🚨 よくある間違い

#### 間違い1: 正規化しすぎる

**対処法**: 正規化は重要ですが、過度に正規化すると、パフォーマンスが低下することがあります。実務では、第3正規形までで十分です。

---

#### 間違い2: 外部キー制約を設定しない

**対処法**: 外部キー制約を設定することで、データの整合性を保つことができます。必ず設定しましょう。

---

#### 間違い3: データ型を適切に選ばない

**対処法**: データ型を適切に選ぶことで、ストレージを節約し、パフォーマンスを向上させることができます。

*   **INT**: 整数（例: ID、年齢）
*   **VARCHAR**: 可変長文字列（例: 名前、メールアドレス）
*   **TEXT**: 長い文字列（例: 記事の本文）
*   **DATE**: 日付（例: 誕生日）
*   **DATETIME**: 日時（例: 作成日時）

---

## Step 8: 実務でのデータベース設計

実務では、データベース設計は以下のような流れで行います。

1. **要件定義**: システムで扱うデータを洗い出す
2. **ER図の作成**: エンティティとリレーションシップを図で表す
3. **テーブル設計**: テーブル名、カラム名、データ型、制約を決める
4. **レビュー**: チームメンバーと、データベース設計を確認する
5. **承認**: データベース設計が承認されたら、マイグレーションファイルを作成する

---

## ✨ まとめ

このセクションでは、タスク管理システムのデータベース設計について学びました。

*   データベース設計は、エンティティの抽出、リレーションシップの定義、テーブル設計の3つのステップで行う。
*   ER図を作成することで、データベースの構造を視覚的に理解できる。
*   正規化を行うことで、データの重複を排除し、データの整合性を保つことができる。
*   外部キー制約を設定することで、データの整合性を保つことができる。

次のセクションでは、画面設計について学びます。

---
